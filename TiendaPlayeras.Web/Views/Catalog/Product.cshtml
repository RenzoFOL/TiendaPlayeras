@model TiendaPlayeras.Web.Models.Product
@{
    ViewData["Title"] = Model.Name;
    
    var productImages = Model.ProductImages?
        .OrderBy(x => x.DisplayOrder)
        .Select(x => x.Path)
        .ToList() ?? new List<string>();
    
    if (!productImages.Any())
    {
        productImages.Add("/images/Product.jpg");
    }
    
    bool showThumbnails = productImages.Count > 1;
    var mainImage = productImages.FirstOrDefault();
    var relatedProducts = ViewBag.RelatedProducts as List<Product> ?? new List<Product>();
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@Model.Name - TiendaPlayeras</title>
    <link rel="stylesheet" href="~/css/kaira/catalog_producto.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="product-page">
    
    <!-- Main Content -->
    <main class="single-product-section">
        <div class="container">
            <!-- Breadcrumb -->
            <nav class="breadcrumb-custom">
                <a href="/">Inicio</a>
                <span>/</span>
                <a href="/Catalog">Cat√°logo</a>
                <span>/</span>
                <span class="current">@Model.Name</span>
            </nav>

            <div class="row product-detail-row">
                <!-- Galer√≠a de im√°genes -->
                <div class="col-lg-6">
                    <div class="product-gallery">
                        <div class="main-image-container">
                            <img src="@mainImage" alt="@Model.Name" class="main-product-image" id="mainProductImage"
                                 onerror="this.src='/images/Product.jpg'">
                            @if (Model.IsCustomizable)
                            {
                                <div class="product-badge customizable-badge">
                                    <i class="fas fa-paint-brush me-1"></i>Personalizable
                                </div>
                            }
                            @if (!Model.IsActive)
                            {
                                <div class="product-badge out-of-stock-badge">
                                    <i class="fas fa-times-circle me-1"></i>Agotado
                                </div>
                            }
                        </div>

                        @if (showThumbnails)
                        {
                            <div class="thumbnail-gallery">
                                @for (int i = 0; i < productImages.Count; i++)
                                {
                                    <div class="thumbnail-item @(i == 0 ? "active" : "")" data-image="@productImages[i]">
                                        <img src="@productImages[i]" alt="Imagen @(i + 1) de @Model.Name"
                                             onerror="this.src='/images/Product.jpg'">
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>

                <!-- Informaci√≥n del producto -->
                <div class="col-lg-6">
                    <div class="product-info-section" data-product-id="@Model.Id"
                         data-product-name="@Model.Name"
                         data-price="@Model.BasePrice.ToString("0.00", System.Globalization.CultureInfo.InvariantCulture)"
                         data-slug="@Model.Slug"
                         data-isactive="@Model.IsActive"
                         data-iscustomizable="@Model.IsCustomizable">
                        <h1 class="product-title-main">@Model.Name</h1>
                        
                        <div class="product-price-main">
                            @Model.BasePrice.ToString("C")
                        </div>

                        <!-- Rating -->
                        <div class="product-rating">
                            <div class="stars">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star-half-alt"></i>
                            </div>
                            <span class="rating-text">(4.5) ‚Ä¢ 128 rese√±as</span>
                        </div>

                        @if (!string.IsNullOrWhiteSpace(Model.Description))
                        {
                            <div class="product-description-text">
                                @Html.Raw(Model.Description.Replace("\n", "<br>"))
                            </div>
                        }

                        <!-- === FORMULARIO CORREGIDO === -->
                        <div class="mt-3" id="productFormContainer">
                            <!-- Selector de tallas -->
                            <div class="size-selector-section">
                                <label class="section-label-kaira">
                                    <i class="fas fa-ruler me-2"></i>Selecciona tu talla
                                </label>
                                <div class="size-options">
                                    @if (Model.SizeS)
                                    {
                                        <label class="size-option-kaira">
                                            <input type="radio" name="selectedSize" value="S" @(Model.SizeM ? "" : "checked")>
                                            <span class="size-label">S</span>
                                        </label>
                                    }
                                    @if (Model.SizeM)
                                    {
                                        <label class="size-option-kaira">
                                            <input type="radio" name="selectedSize" value="M" checked>
                                            <span class="size-label">M</span>
                                        </label>
                                    }
                                    @if (Model.SizeL)
                                    {
                                        <label class="size-option-kaira">
                                            <input type="radio" name="selectedSize" value="L">
                                            <span class="size-label">L</span>
                                        </label>
                                    }
                                    @if (Model.SizeXL)
                                    {
                                        <label class="size-option-kaira">
                                            <input type="radio" name="selectedSize" value="XL">
                                            <span class="size-label">XL</span>
                                        </label>
                                    }
                                </div>
                                <div class="size-guide-link">
                                    <a href="#size-guide-modal" data-bs-toggle="modal">
                                        <i class="fas fa-info-circle me-1"></i>Gu√≠a de tallas
                                    </a>
                                </div>
                            </div>

                            <!-- Cantidad -->
                            <div class="quantity-selector">
                                <label class="section-label-kaira">
                                    <i class="fas fa-list-ol me-2"></i>Cantidad
                                </label>
                                <div class="quantity-wrapper">
                                    <button type="button" class="qty-btn" id="decreaseQty">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <input type="number" class="qty-input" id="quantity" value="1" min="1" max="99" readonly>
                                    <button type="button" class="qty-btn" id="increaseQty">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Botones de acci√≥n -->
                            <div class="product-actions">
                                <button type="button" class="btn-kaira btn-kaira-primary" id="btnAddToCart" 
                                        @(!Model.IsActive ? "disabled" : "")
                                        data-product-id="@Model.Id">
                                    <i class="fas fa-shopping-cart me-2"></i>
                                    @(Model.IsActive ? "AGREGAR AL CARRITO" : "Agotado")
                                </button>
                                <button type="button" class="btn-kaira btn-kaira-success" id="btnBuyNow"
                                        @(!Model.IsActive ? "disabled" : "")>
                                    <i class="fas fa-bolt me-2"></i>
                                    Comprar ahora
                                </button>
                                <button type="button" class="btn-wishlist-kaira js-add-wishlist" id="btnWishlist"
                                        data-product-id="@Model.Id" title="Agregar a mi wishlist">
                                    <i class="fas fa-heart"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Caracter√≠sticas del producto -->
                        <div class="product-features">
                            <div class="feature-item">
                                <div class="feature-icon">
                                    <i class="fas fa-shipping-fast"></i>
                                </div>
                                <div class="feature-content">
                                    <h6>Env√≠o gratis</h6>
                                    <p>En compras mayores a $500</p>
                                </div>
                            </div>
                            <div class="feature-item">
                                <div class="feature-icon">
                                    <i class="fas fa-undo-alt"></i>
                                </div>
                                <div class="feature-content">
                                    <h6>Devoluciones gratuitas</h6>
                                    <p>Dentro de 30 d√≠as</p>
                                </div>
                            </div>
                            <div class="feature-item">
                                <div class="feature-icon">
                                    <i class="fas fa-award"></i>
                                </div>
                                <div class="feature-content">
                                    <h6>100% Algod√≥n premium</h6>
                                    <p>Calidad garantizada</p>
                                </div>
                            </div>
                        </div>

                        <!-- Tags -->
                        @if (Model.ProductTags?.Any(pt => pt.IsActive && pt.Tag != null && pt.Tag.IsActive) == true)
                        {
                            <div class="product-tags">
                                <label class="section-label-kaira">
                                    <i class="fas fa-tags me-2"></i>Colecciones
                                </label>
                                <div class="tags-list">
                                    @foreach (var pt in Model.ProductTags
                                        .Where(pt => pt.IsActive && pt.Tag != null && pt.Tag.IsActive)
                                        .OrderBy(pt => pt.Tag!.Name))
                                    {
                                        <a href="/Catalog?tag=@pt.Tag!.Slug" class="tag-item">
                                            <i class="fas fa-tag me-1"></i>@pt.Tag!.Name
                                        </a>
                                    }
                                </div>
                            </div>
                        }

                        <!-- Informaci√≥n adicional -->
                        <div class="additional-info">
                            <div class="info-item">
                                <i class="fas fa-box me-2"></i>
                                <span>Disponibilidad: <strong>@(Model.IsActive ? "En stock" : "Agotado")</strong></span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-shield-alt me-2"></i>
                                <span>Garant√≠a: <strong>30 d√≠as</strong></span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-truck me-2"></i>
                                <span>Env√≠o: <strong>2-3 d√≠as h√°biles</strong></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs de informaci√≥n adicional -->
            <div class="product-tabs-section">
                <ul class="nav nav-tabs" id="productTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="description-tab" data-bs-toggle="tab" 
                                data-bs-target="#description" type="button" role="tab">
                            <i class="fas fa-file-alt me-2"></i>Descripci√≥n
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="specs-tab" data-bs-toggle="tab" 
                                data-bs-target="#specs" type="button" role="tab">
                            <i class="fas fa-info-circle me-2"></i>Especificaciones
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" 
                                data-bs-target="#reviews" type="button" role="tab">
                            <i class="fas fa-star me-2"></i>Rese√±as
                        </button>
                    </li>
                </ul>
                <div class="tab-content" id="productTabsContent">
                    <div class="tab-pane fade show active" id="description" role="tabpanel">
                        <div class="tab-content-inner">
                            <h4>Descripci√≥n del Producto</h4>
                            @if (!string.IsNullOrWhiteSpace(Model.Description))
                            {
                                <p>@Model.Description</p>
                            }
                            else
                            {
                                <p>Esta playera premium est√° dise√±ada para ofrecerte el m√°ximo confort y estilo.</p>
                            }
                            
                            <div class="features-list">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="feature-detail">
                                            <i class="fas fa-check text-success me-2"></i>
                                            <span>Material: 100% Algod√≥n Premium</span>
                                        </div>
                                        <div class="feature-detail">
                                            <i class="fas fa-check text-success me-2"></i>
                                            <span>Lavable a m√°quina</span>
                                        </div>
                                        <div class="feature-detail">
                                            <i class="fas fa-check text-success me-2"></i>
                                            <span>No se decolora</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="feature-detail">
                                            <i class="fas fa-check text-success me-2"></i>
                                            <span>Costuras reforzadas</span>
                                        </div>
                                        <div class="feature-detail">
                                            <i class="fas fa-check text-success me-2"></i>
                                            <span>Estampado de alta calidad</span>
                                        </div>
                                        <div class="feature-detail">
                                            <i class="fas fa-check text-success me-2"></i>
                                            <span>Comodidad garantizada</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="specs" role="tabpanel">
                        <div class="tab-content-inner">
                            <h4>Especificaciones T√©cnicas</h4>
                            <div class="specs-table">
                                <div class="spec-row">
                                    <div class="spec-name">Material</div>
                                    <div class="spec-value">100% Algod√≥n Premium</div>
                                </div>
                                <div class="spec-row">
                                    <div class="spec-name">Gramaje</div>
                                    <div class="spec-value">180 g/m¬≤</div>
                                </div>
                                <div class="spec-row">
                                    <div class="spec-name">Cuidado</div>
                                    <div class="spec-value">Lavable a m√°quina 30¬∞C</div>
                                </div>
                                <div class="spec-row">
                                    <div class="spec-name">Origen</div>
                                    <div class="spec-value">Hecho en M√©xico</div>
                                </div>
                                <div class="spec-row">
                                    <div class="spec-name">Tallas disponibles</div>
                                    <div class="spec-value">
                                        @{
                                            var availableSizes = new List<string>();
                                            if (Model.SizeS) availableSizes.Add("S");
                                            if (Model.SizeM) availableSizes.Add("M");
                                            if (Model.SizeL) availableSizes.Add("L");
                                            if (Model.SizeXL) availableSizes.Add("XL");
                                        }
                                        @string.Join(", ", availableSizes)
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="reviews" role="tabpanel">
                        <div class="tab-content-inner">
                            <h4>Opiniones de Clientes</h4>
                            <div class="reviews-summary">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="rating-overview text-center">
                                            <div class="average-rating">4.5</div>
                                            <div class="stars">
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star-half-alt"></i>
                                            </div>
                                            <div class="total-reviews">128 rese√±as</div>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="rating-bars">
                                            <div class="rating-bar">
                                                <span class="rating-label">5 estrellas</span>
                                                <div class="bar-container">
                                                    <div class="bar-fill" style="width: 70%"></div>
                                                </div>
                                                <span class="rating-count">70%</span>
                                            </div>
                                            <div class="rating-bar">
                                                <span class="rating-label">4 estrellas</span>
                                                <div class="bar-container">
                                                    <div class="bar-fill" style="width: 20%"></div>
                                                </div>
                                                <span class="rating-count">20%</span>
                                            </div>
                                            <div class="rating-bar">
                                                <span class="rating-label">3 estrellas</span>
                                                <div class="bar-container">
                                                    <div class="bar-fill" style="width: 7%"></div>
                                                </div>
                                                <span class="rating-count">7%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Productos relacionados -->
            @if (relatedProducts.Any())
            {
                <section class="related-products-section">
                    <div class="section-header">
                        <h3 class="section-title">Productos Relacionados</h3>
                        <a href="/Catalog" class="view-all-link">Ver todos</a>
                    </div>
                    <div class="row">
                        @foreach (var relatedProduct in relatedProducts.Take(4))
                        {
                            var relatedImage = relatedProduct.ProductImages?.FirstOrDefault()?.Path ?? "/images/Product.jpg";
                            <div class="col-lg-3 col-md-6">
                                <div class="related-product-item">
                                    <div class="product-image">
                                        <a href="/Catalog/Product?slug=@relatedProduct.Slug">
                                            <img src="@relatedImage" alt="@relatedProduct.Name" 
                                                 onerror="this.src='/images/Product.jpg'">
                                        </a>
                                        <button class="wishlist-btn js-add-wishlist"
                                                data-product-id="@relatedProduct.Id"
                                                title="Agregar a mi wishlist">
                                            <i class="fas fa-heart"></i>
                                        </button>
                                    </div>
                                    <div class="product-info">
                                        <h5 class="product-name">
                                            <a href="/Catalog/Product?slug=@relatedProduct.Slug">@relatedProduct.Name</a>
                                        </h5>
                                        <div class="product-price">@relatedProduct.BasePrice.ToString("C")</div>

                                        <button type="button" class="btn-add-to-cart js-related-quick-add"
                                                data-product-id="@relatedProduct.Id"
                                                data-product-name="@relatedProduct.Name">
                                            <i class="fas fa-shopping-cart me-2"></i>Agregar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </section>
            }
        </div>
    </main>

    <!-- Footer -->
    <footer id="footer" class="mt-5">
        <div class="container"></div>
    </footer>

    <!-- Modal Gu√≠a de Tallas -->
    <div class="modal fade" id="size-guide-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Gu√≠a de Tallas</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="size-guide-table">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Talla</th>
                                    <th>Pecho (cm)</th>
                                    <th>Largo (cm)</th>
                                    <th>Manga (cm)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>S</td><td>91-96</td><td>66</td><td>20</td></tr>
                                <tr><td>M</td><td>96-101</td><td>69</td><td>21</td></tr>
                                <tr><td>L</td><td>101-106</td><td>72</td><td>22</td></tr>
                                <tr><td>XL</td><td>106-111</td><td>74</td><td>23</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- <script src="~/js/kaira/catalog_producto.js"></script> -->

<script>
const metaToken = document.querySelector('meta[name="RequestVerificationToken"]');
const XSRF = metaToken?.content || '';

// Wishlist
(function () {
  async function postJson(url, data) {
    const resp = await fetch(url, {
      method: 'POST',
      credentials: 'same-origin',
      headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': XSRF },
      body: JSON.stringify(data || {})
    });
    if (resp.status === 401) {
      window.location.href = '/Account/Login?returnUrl=' + encodeURIComponent(location.pathname + location.search);
      return null;
    }
    try { return await resp.json(); } catch { return null; }
  }

  function markActive(btn) {
    btn.classList.add('active');
    const i = btn.querySelector('i.fas.fa-heart');
    if (i) i.classList.add('text-danger');
  }

  document.querySelectorAll('.js-add-wishlist').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const pid = parseInt(btn.getAttribute('data-product-id'), 10);
      if (!pid) return;
      const res = await postJson('/Wishlist/Add', { productId: pid });
      if (res && res.ok) markActive(btn);
    });
  });
})();

// Control cantidad
(function () {
  const qty = document.getElementById('quantity');
  document.getElementById('decreaseQty')?.addEventListener('click', () => {
    qty.value = Math.max(1, (parseInt(qty.value) || 1) - 1);
  });
  document.getElementById('increaseQty')?.addEventListener('click', () => {
    qty.value = Math.min(99, (parseInt(qty.value) || 1) + 1);
  });
})();

// AGREGAR AL CARRITO PRINCIPAL (CORREGIDO - sin alerta de error 404)
(function () {
  const btnAdd = document.getElementById('btnAddToCart');
  if (!btnAdd) return;

  btnAdd.addEventListener('click', async function() {
    const productId = parseInt(this.getAttribute('data-product-id'), 10);
    if (!productId) {
      alert('‚ùå Error: ID de producto no v√°lido');
      return;
    }

    const sizeInput = document.querySelector('input[name="selectedSize"]:checked');
    if (!sizeInput) {
      alert('‚ö†Ô∏è Por favor selecciona una talla');
      return;
    }

    const data = {
      productId: productId,
      size: sizeInput.value,
      qty: parseInt(document.getElementById('quantity')?.value || '1', 10)
    };

    const originalHtml = this.innerHTML;
    this.disabled = true;
    this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Agregando...';

    try {
      const response = await fetch('/Cart/Add', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json',
          'RequestVerificationToken': XSRF
        },
        body: JSON.stringify(data)
      });

      // üî¥ CORRECCI√ìN: Manejo mejorado de respuestas
      if (response.status === 401) {
        window.location.href = '/Account/Login?returnUrl=' + encodeURIComponent(location.pathname + location.search);
        return;
      }

      // Intentar parsear JSON
      let result;
      try {
        result = await response.json();
      } catch (jsonError) {
        // Si no es JSON v√°lido, verificar si fue exitoso por el status code
        if (response.ok) {
          // Considerarlo √©xito si el status es 200-299
          result = { ok: true };
        } else {
          throw new Error('Error al procesar la respuesta del servidor');
        }
      }

      // Verificar √©xito
      if (result.ok || response.ok) {
        // ‚úÖ √âxito
        if (typeof window.refreshCartBadges === 'function') {
          await window.refreshCartBadges();
        }
        if (typeof window.openCartAfterAdd === 'function') {
          await window.openCartAfterAdd();
        }
        
        this.innerHTML = '<i class="fas fa-check me-2"></i>¬°Agregado!';
        setTimeout(() => {
          this.innerHTML = originalHtml;
          this.disabled = false;
        }, 1500);
      } else {
        throw new Error(result.message || 'No se pudo agregar al carrito');
      }
    } catch (error) {
      console.error('Error al agregar al carrito:', error);
      // üî¥ Solo mostrar alerta si realmente hay un error (no si funcion√≥)
      if (!error.message.includes('JSON')) {
        alert('‚ùå ' + error.message);
      }
      this.innerHTML = originalHtml;
      this.disabled = false;
    }
  });
})();

// PRODUCTOS RELACIONADOS (CORREGIDO)
document.addEventListener('click', async function(e) {
  const btn = e.target.closest('.js-related-quick-add');
  if (!btn) return;

  e.preventDefault();
  const productId = parseInt(btn.getAttribute('data-product-id'), 10);
  if (!productId) return;

  const originalHtml = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Agregando';

  try {
    const response = await fetch('/Cart/Add', {
      method: 'POST',
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/json',
        'RequestVerificationToken': XSRF
      },
      body: JSON.stringify({ productId: productId, size: 'M', qty: 1 })
    });

    if (response.status === 401) {
      window.location.href = '/Account/Login?returnUrl=' + encodeURIComponent(location.pathname + location.search);
      return;
    }

    // üî¥ CORRECCI√ìN: Mismo manejo mejorado
    let result;
    try {
      result = await response.json();
    } catch (jsonError) {
      if (response.ok) {
        result = { ok: true };
      } else {
        throw new Error('Error al procesar respuesta');
      }
    }

    if (result.ok || response.ok) {
      if (typeof window.refreshCartBadges === 'function') await window.refreshCartBadges();
      if (typeof window.openCartAfterAdd === 'function') await window.openCartAfterAdd();

      btn.innerHTML = '<i class="fas fa-check me-2"></i>¬°Agregado!';
      setTimeout(() => {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
      }, 1500);
    } else {
      throw new Error(result.message || 'Error');
    }
  } catch (error) {
    console.error('Error:', error);
    if (!error.message.includes('JSON')) {
      alert('‚ùå ' + error.message);
    }
    btn.innerHTML = originalHtml;
    btn.disabled = false;
  }
});

// COMPRAR AHORA
document.getElementById('btnBuyNow')?.addEventListener('click', function() {
  alert('üöÄ Funci√≥n pr√≥ximamente');
});

console.log('üõçÔ∏è P√°gina de producto cargada correctamente');
</script>

</body>
</html>
