@model Order
@{
    ViewData["Title"] = $"Pedido #{Model.OrderNumber}";
}

<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Pedido @Model.OrderNumber</h2>
        <a href="@Url.Action("Index")" class="btn btn-outline-secondary">Volver a Mis Pedidos</a>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Detalles del Pedido</h5>
                </div>
                <div class="card-body">
                    <!-- Información general -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <p><strong>Número de Orden:</strong><br>@Model.OrderNumber</p>
                            <p><strong>Total:</strong><br>@Model.Total.ToString("C")</p>
                            <p><strong>Estado:</strong><br>
                                <span class="badge @GetStatusBadgeClass(Model.Status)">
                                    @Model.StatusDisplay
                                </span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Punto de Entrega:</strong><br>@Model.DeliveryPoint</p>
                            <p><strong>Horario:</strong><br>@Model.DeliverySchedule</p>
                            <p><strong>Método de Pago:</strong><br>@Model.PaymentMethod</p>
                        </div>
                    </div>

                    <!-- Productos -->
                    <h6>Productos:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Talla</th>
                                    <th class="text-center">Cantidad</th>
                                    <th class="text-end">Precio Unitario</th>
                                    <th class="text-end">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.Items)
                                {
                                    <tr>
                                        <td>@item.ProductName</td>
                                        <td>@item.Size</td>
                                        <td class="text-center">@item.Quantity</td>
                                        <td class="text-end">@item.UnitPrice.ToString("C")</td>
                                        <td class="text-end">@item.TotalPrice.ToString("C")</td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="4" class="text-end"><strong>Total:</strong></td>
                                    <td class="text-end"><strong>@Model.Total.ToString("C")</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Información de entrega -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Información de Entrega</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>Instrucciones importantes</h6>
                        <ul class="mb-0">
                            <li>Presenta tu identificación al momento de recoger tu pedido</li>
                            <li>Llega puntual al horario seleccionado: <strong>@Model.DeliverySchedule</strong></li>
                            <li>Acude al punto: <strong>@Model.DeliveryPoint</strong></li>
                            <li>El pago se realiza al momento de la entrega</li>
                            <li>Trae este número de orden: <strong>@Model.OrderNumber</strong></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Acciones -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Acciones</h5>
                </div>
                <div class="card-body">
                    <!-- Aquí puedes agregar botones para descargar tickets si los generas para Orders -->
                    @if (Model.Status == "ReadyForPickup")
                    {
                        <div class="alert alert-success">
                            <h6><i class="fas fa-check-circle me-2"></i>¡Listo para recoger!</h6>
                            <p class="mb-0">Tu pedido está listo. Acude al punto de entrega en el horario seleccionado.</p>
                        </div>
                    }
                    
                    @if (Model.Status == "Completed")
                    {
                        <div class="alert alert-secondary">
                            <h6><i class="fas fa-flag-checkered me-2"></i>Pedido Completado</h6>
                            <p class="mb-0">Este pedido ha sido entregado y completado.</p>
                        </div>
                    }
                    
                    @if (Model.Status == "Cancelled")
                    {
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-times-circle me-2"></i>Pedido Cancelado</h6>
                            <p class="mb-0">Este pedido ha sido cancelado.</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Resumen del pedido -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Resumen</h5>
                </div>
                <div class="card-body">
                    <p><strong>Fecha del Pedido:</strong><br>@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</p>
                    <p><strong>Total de Productos:</strong><br>@Model.TotalItems producto(s)</p>
                    <p><strong>Subtotal:</strong><br>@Model.Subtotal.ToString("C")</p>
                    <p><strong>Envío:</strong><br>@Model.Shipping.ToString("C")</p>
                    <p><strong>Total:</strong><br><strong>@Model.Total.ToString("C")</strong></p>
                </div>
            </div>

            <!-- Estado actual -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Seguimiento</h5>
                </div>
                <div class="card-body">
                    <div class="order-timeline">
                        @{
                            var statuses = new[] { "Pending", "Confirmed", "InProgress", "ReadyForPickup", "Completed" };
                            var currentIndex = Array.IndexOf(statuses, Model.Status);
                        }
                        
                        @foreach (var status in statuses)
                        {
                            var isCompleted = Array.IndexOf(statuses, status) <= currentIndex;
                            var isCurrent = status == Model.Status;
                            
                            <div class="timeline-step @(isCompleted ? "completed" : "") @(isCurrent ? "current" : "")">
                                <div class="timeline-icon">
                                    @if (isCompleted)
                                    {
                                        <i class="fas fa-check"></i>
                                    }
                                    else
                                    {
                                        <i class="fas fa-circle"></i>
                                    }
                                </div>
                                <div class="timeline-label">
                                    @OrderStatus.GetDisplayName(status)
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
<style>
    .order-timeline {
        position: relative;
        padding-left: 30px;
    }
    
    .timeline-step {
        position: relative;
        padding: 10px 0;
        display: flex;
        align-items: center;
    }
    
    .timeline-step:not(:last-child):after {
        content: '';
        position: absolute;
        left: 12px;
        top: 40px;
        bottom: -10px;
        width: 2px;
        background: #dee2e6;
    }
    
    .timeline-step.completed:after {
        background: #198754;
    }
    
    .timeline-icon {
        width: 26px;
        height: 26px;
        border-radius: 50%;
        background: #dee2e6;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        position: relative;
        z-index: 2;
        font-size: 12px;
    }
    
    .timeline-step.completed .timeline-icon {
        background: #198754;
        color: white;
    }
    
    .timeline-step.current .timeline-icon {
        background: #0d6efd;
        color: white;
    }
    
    .timeline-label {
        font-size: 0.9rem;
    }
    
    .timeline-step.completed .timeline-label {
        color: #198754;
        font-weight: 500;
    }
    
    .timeline-step.current .timeline-label {
        color: #0d6efd;
        font-weight: 600;
    }
</style>
}

@functions {
    string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Pending" => "bg-warning",
            "Confirmed" => "bg-info",
            "InProgress" => "bg-primary",
            "ReadyForPickup" => "bg-success",
            "Completed" => "bg-secondary",
            "Cancelled" => "bg-danger",
            _ => "bg-light text-dark"
        };
    }
}