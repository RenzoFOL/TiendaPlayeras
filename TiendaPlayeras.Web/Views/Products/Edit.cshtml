@model TiendaPlayeras.Web.Models.Product
@{
    ViewData["Title"] = "Editar Producto";
    
    var productImages = Model.ProductImages?.OrderBy(x => x.DisplayOrder).ToList() ?? new List<ProductImage>();
    bool showThumbnails = productImages.Count > 1;
    int imagesCount = productImages.Count;
}

<link rel="stylesheet" href="~/css/kaira/edit_producto.css">

<div class="edit-container">
    <div class="container-fluid">
        <div class="edit-header">
            <h2>
                <i class="fas fa-edit"></i>
                Editar: @Model.Name
                <small style="font-size: 14px; color: #666; margin-left: 10px;">
                    (@imagesCount imagen@(imagesCount != 1 ? "es" : ""))
                </small>
            </h2>
            <a class="btn-back" href="@Url.Action("Index")">
                <i class="fas fa-arrow-left"></i>
                Regresar
            </a>
        </div>

        <!-- Mostrar mensajes de éxito/error -->
        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>
                @TempData["Success"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }
        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                @TempData["Error"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        <div class="form-card">
            <form method="post" asp-action="SaveProductWithTags" asp-route-id="@Model.Id" enctype="multipart/form-data" id="editForm">
                @Html.AntiForgeryToken()

                <!-- Sección: Imágenes del Producto -->
                <div class="form-section">
                    <div class="section-title">
                        <i class="fas fa-images"></i>
                        Imágenes del Producto
                        <span class="images-count-badge" id="imagesCount">@imagesCount imagen@(imagesCount != 1 ? "es" : "")</span>
                    </div>

                    <div class="image-section">
                        <label class="form-label">
                            <i class="fas fa-image me-2"></i>
                            Imágenes Actuales
                        </label>
                        <div id="currentImagesGrid" class="current-images-grid">
                            @if (productImages.Any())
                            {
                                foreach (var img in productImages)
                                {
                                    <div class="current-image-item">
                                        <img src="@img.Path" alt="@img.AltText" 
                                             onerror="this.src='https://via.placeholder.com/150?text=Error+Imagen'">
                                        <button type="button" class="delete-image" data-id="@img.Id">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        @if (img.IsMain)
                                        {
                                            <span class="main-badge"><i class="fas fa-star me-1"></i>Principal</span>
                                        }
                                        else
                                        {
                                            <button type="button" class="set-main-btn" data-id="@img.Id" title="Marcar como principal">
                                                <i class="fas fa-star"></i>
                                            </button>
                                        }
                                        <div class="image-info">
                                            <div>Orden: @img.DisplayOrder</div>
                                            @if (img.IsMain)
                                            {
                                                <div><strong>Principal</strong></div>
                                            }
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="no-images-message">
                                    <i class="fas fa-image me-2"></i>
                                    No hay imágenes cargadas para este producto
                                </div>
                            }
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-camera me-2"></i>
                                Agregar Nuevas Imágenes
                            </label>

                            <div class="images-upload-area" onclick="document.getElementById('newImagesInput').click()">
                                <div class="upload-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <h6>Haz clic para seleccionar imágenes</h6>
                                <p class="text-muted mb-0">o arrastra y suelta aquí</p>
                                <input type="file" 
                                       id="newImagesInput"
                                       name="images" 
                                       accept=".jpg,.jpeg,.png,.webp,.gif" 
                                       multiple
                                       style="display: none;" />
                            </div>
                            <div class="form-text mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                Formatos: JPG/PNG/WebP/GIF — máximo 10MB por imagen
                            </div>
                            <div class="upload-status" id="uploadStatus"></div>
                            <div class="images-preview-grid" id="newImagesPreview"></div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Tallas Disponibles - ACTUALIZADO PARA BOOLEANOS -->
                <div class="form-section">
                    <div class="section-title">
                        <i class="fas fa-ruler"></i>
                        Tallas Disponibles
                        <span class="badge bg-primary ms-2" id="sizeCounter">
                            @{
                                var selectedCount = (Model.SizeS ? 1 : 0) + (Model.SizeM ? 1 : 0) + 
                                                  (Model.SizeL ? 1 : 0) + (Model.SizeXL ? 1 : 0);
                            }
                            @selectedCount talla@(selectedCount != 1 ? "s" : "")
                        </span>
                    </div>

                    <div class="row g-4">
                        <div class="col-12">
                            <label class="form-label">
                                <i class="fas fa-tshirt"></i>
                                Selecciona las tallas disponibles
                            </label>
                            <div class="size-options-grid">
                                <div class="form-check form-check-size">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           name="sizeS" 
                                           value="true" 
                                           id="sizeS" 
                                           @(Model.SizeS ? "checked" : "")>
                                    <label class="form-check-label" for="sizeS">
                                        S
                                    </label>
                                </div>
                                <div class="form-check form-check-size">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           name="sizeM" 
                                           value="true" 
                                           id="sizeM"
                                           @(Model.SizeM ? "checked" : "")>
                                    <label class="form-check-label" for="sizeM">
                                        M
                                    </label>
                                </div>
                                <div class="form-check form-check-size">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           name="sizeL" 
                                           value="true" 
                                           id="sizeL"
                                           @(Model.SizeL ? "checked" : "")>
                                    <label class="form-check-label" for="sizeL">
                                        L
                                    </label>
                                </div>
                                <div class="form-check form-check-size">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           name="sizeXL" 
                                           value="true" 
                                           id="sizeXL"
                                           @(Model.SizeXL ? "checked" : "")>
                                    <label class="form-check-label" for="sizeXL">
                                        XL
                                    </label>
                                </div>
                            </div>
                            
                            <div class="helper-text">
                                <i class="fas fa-info-circle"></i>
                                Las tallas seleccionadas estarán disponibles para este producto
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Información Básica -->
                <div class="form-section">
                    <div class="section-title">
                        <i class="fas fa-info-circle"></i>
                        Información Básica
                    </div>

                    <div class="row g-4">
                        <div class="col-lg-6">
                            <div class="form-floating">
                                <input asp-for="Name" 
                                       class="form-control" 
                                       placeholder="Nombre" 
                                       maxlength="100" 
                                       required />
                                <label asp-for="Name">
                                    Nombre del Producto <span class="req">*</span>
                                </label>
                            </div>
                            <span class="text-danger" asp-validation-for="Name"></span>
                        </div>

                        <div class="col-lg-3">
                            <div class="form-floating">
                                <input asp-for="BasePrice" 
                                       type="number" 
                                       step="0.01" 
                                       min="0" 
                                       class="form-control" 
                                       placeholder="0.00" 
                                       required />
                                <label asp-for="BasePrice">
                                    Precio Base <span class="req">*</span>
                                </label>
                            </div>
                            <span class="text-danger" asp-validation-for="BasePrice"></span>
                        </div>

                        <div class="col-lg-3">
                            <div class="switch-group">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" 
                                           asp-for="IsActive" 
                                           id="IsActive" 
                                           role="switch" />
                                    <label class="form-check-label" for="IsActive">
                                        Habilitado
                                    </label>
                                </div>
                                <div class="form-text">
                                    <i class="fas fa-eye me-1"></i>
                                    Visible en el catálogo
                                </div>
                            </div>
                        </div>

                        <div class="col-12">
                            <label class="form-label">
                                <i class="fas fa-align-left"></i>
                                Descripción del Producto
                            </label>
                            <textarea asp-for="Description" 
                                      class="form-control" 
                                      rows="4" 
                                      maxlength="2000"
                                      placeholder="Describe las características del producto..."></textarea>
                            <span class="text-danger" asp-validation-for="Description"></span>
                        </div>
                    </div>
                </div>

                <!-- Sección: Etiquetas -->
                <div class="form-section">
                    <div class="section-title">
                        <i class="fas fa-tags"></i>
                        Gestión de Etiquetas
                    </div>

                    <div class="tags-section">
                        <label class="form-label">
                            <i class="fas fa-search"></i>
                            Buscar y Agregar Etiquetas
                        </label>
                        <input type="text" 
                               id="tagSearch" 
                               class="form-control tag-search-input" 
                               placeholder="Escribe para buscar etiquetas (ej: mustang, rock, deportes)"/>
                        
                        <div id="tagSuggestions" class="list-group mt-2"></div>
                        
                        <a href="@Url.Action("Tags", "CategoryTags")" class="create-tag-link" target="_blank">
                            <i class="fas fa-plus-circle"></i>
                            ¿No encuentras la etiqueta? Créala aquí
                        </a>
                        
                        <label class="form-label mt-3">
                            <i class="fas fa-check-circle"></i>
                            Etiquetas Seleccionadas
                        </label>
                        <div id="selectedTags">
                            <span class="empty-tags">
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                Cargando etiquetas...
                            </span>
                        </div>
                    </div>
                </div>

                <div id="hiddenTags"></div>

                <div class="d-flex gap-3 flex-wrap justify-content-center">
                    <button class="btn btn-save" type="submit" id="submitBtn">
                        <i class="fas fa-save"></i>
                        Guardar Cambios
                    </button>
                    <a class="btn btn-cancel" href="@Url.Action("Index")">
                        <i class="fas fa-times"></i>
                        Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Inyectar las imágenes del producto en una variable global
        window.__productImages = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
            productImages.Select(p => new { 
                id = p.Id, 
                path = p.Path, 
                isMain = p.IsMain, 
                displayOrder = p.DisplayOrder 
            })
        ));
    </script>
    <script src="~/js/edit_producto.js"></script>
}