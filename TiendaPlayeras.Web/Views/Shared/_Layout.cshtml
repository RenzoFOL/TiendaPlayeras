@* _Layout.cshtml (carrito dinámico CORREGIDO) *@
<!DOCTYPE html>
<html lang="es">
<head>
    <title>Kaira - Bootstrap 5 Fashion Store HTML CSS Template</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="author" content="TemplatesJungle">
    <meta name="keywords" content="ecommerce,fashion,store">
    <meta name="description" content="Bootstrap 5 Fashion Store HTML CSS Template">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.css" />

    <!-- CSS del tema Kaira -->
    <link rel="stylesheet" href="~/css/kaira/normalize.css" asp-append-version="true">
    <link rel="stylesheet" href="~/css/kaira/swiper-bundle.min.css" asp-append-version="true">
    <link rel="stylesheet" href="~/css/kaira/style.css" asp-append-version="true">
    <link rel="stylesheet" href="~/css/kaira/enhanced.css" asp-append-version="true">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&family=Marcellus&display=swap" rel="stylesheet">

    <!-- 🔽 CSS del proyecto -->
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/account.css" asp-append-version="true" />
    <!-- 🔼 -->

    <style>
        :root {
            --primary-color: #111;
            --secondary-color: #666;
            --hover-color: #66513e;
            --admin-color: #667eea;
            --employee-color: #4facfe;
            --transition-speed: 0.3s;
            --shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .navbar-enhanced { background: rgba(255,255,255,.95)!important; backdrop-filter: blur(10px); transition: all var(--transition-speed) ease; box-shadow: 0 2px 20px rgba(0,0,0,.05); position: sticky; top: 0; z-index: 1050; }
        .navbar-enhanced.scrolled { background: rgba(255,255,255,.98)!important; box-shadow: var(--shadow); }
        .navbar-brand { transition: transform var(--transition-speed) ease; }
        .navbar-brand:hover { transform: scale(1.05); }
        .nav-link-enhanced { position: relative; font-weight: 500; text-transform: uppercase; letter-spacing: .5px; padding: .75rem 1rem!important; transition: all var(--transition-speed) ease; color: var(--primary-color)!important; }
        .nav-link-enhanced::before { content: ''; position: absolute; bottom: 0; left: 50%; width: 0; height: 2px; background: var(--hover-color); transition: all var(--transition-speed) ease; transform: translateX(-50%); }
        .nav-link-enhanced:hover::before, .nav-link-enhanced.active::before { width: 80%; }
        .nav-link-enhanced:hover, .nav-link-enhanced.active { color: var(--hover-color)!important; transform: translateY(-2px); }

        .panel-button { background: linear-gradient(135deg, var(--admin-color), #764ba2); color: white!important; padding: .6rem 1.5rem!important; border-radius: 25px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; transition: all .3s ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); border: none; display: inline-flex; align-items: center; gap: .5rem; }
        .panel-button.employee { background: linear-gradient(135deg, var(--employee-color), #00f2fe); box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3); }
        .panel-button:hover { transform: translateY(-2px) scale(1.05); box-shadow: 0 6px 25px rgba(102, 126, 234, 0.4); color: white!important; }
        .panel-button.employee:hover { box-shadow: 0 6px 25px rgba(79, 172, 254, 0.4); }

        .dropdown-menu-enhanced { border: none; border-radius: 12px; box-shadow: var(--shadow); padding: 1rem 0; margin-top: .5rem; opacity: 0; transform: translateY(-10px); transition: all var(--transition-speed) ease; pointer-events: none; }
        .dropdown:hover .dropdown-menu-enhanced, .dropdown-menu-enhanced.show { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .dropdown-item-enhanced { padding: .75rem 1.5rem; transition: all .2s ease; border-radius: 8px; margin: 0 .5rem; font-weight: 500; }
        .dropdown-item-enhanced:hover { background: linear-gradient(135deg, var(--hover-color), #66513e); color: #fff; transform: translateX(5px); }
        .user-box .dropdown-menu-enhanced { min-width: 200px; right: 0; left: auto; }
        .user-button-enhanced { position: relative; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 50%; transition: all var(--transition-speed) ease; }
        .user-button-enhanced:hover { background: rgb(102,81,62); transform: scale(1.1); }

        .nav-icon-enhanced { transition: all .2s ease; }
        .nav-icon-enhanced:hover { transform: scale(1.2); filter: drop-shadow(0 0 5px rgb(102,81,62)); }

        .mobile-icon-enhanced { width: 24px; height: 24px; transition: all .2s ease; }
        .mobile-icon-enhanced:hover { transform: scale(1.2); color: var(--hover-color); }

        .badge-enhanced { font-size: .7em; padding: .3em .5em; border-radius: 50px; background: var(--hover-color); color: #fff; margin-left: .2rem; }

        .cart-item:hover { background-color: #f8f9fa; }
        .alert-position { position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; }
        .breadcrumb-custom { font-size: 0.9rem; }
        .breadcrumb-custom a { color: #666; text-decoration: none; }
        .breadcrumb-custom a:hover { color: #111; }
        .breadcrumb-custom .current { color: #111; font-weight: 500; }

        /* Estilos para el modal de autenticación */
        #authRequiredModal .modal-content {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: none;
        }

        #authRequiredModal .modal-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px 15px 0 0;
        }

        #authRequiredModal .modal-body {
            padding: 2rem;
        }

        #authRequiredModal .btn-primary {
            background: linear-gradient(135deg, #66513e, #66513e);
            border: none;
            border-radius: 25px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
        }

        #authRequiredModal .btn-outline-secondary {
            border-radius: 25px;
            padding: 0.75rem 1.5rem;
        }
    </style>

    @* Anti-forgery para wishlist/carrito *@
    @inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Xsrf
    @{
        var token = Xsrf.GetAndStoreTokens(Context).RequestToken;
    }
    <meta name="RequestVerificationToken" content="@token" />

    @RenderSection("Styles", required: false)
</head>

<body class="homepage">
    <!-- SVG Icons -->
    <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
        <defs>
            <symbol id="heart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
            </symbol>
            <symbol id="cart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="m1 1 4 4 2 13 10 0 3-10-10 0"/>
            </symbol>
            <symbol id="search" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
            </symbol>
            <symbol id="user" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
            </symbol>
        </defs>
    </svg>

    <div class="preloader text-white fs-6 text-uppercase overflow-hidden"></div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-enhanced text-uppercase fs-6 p-3 border-bottom align-items-center @(User.IsInRole("Admin") ? "admin-nav" : User.IsInRole("Employee") ? "employee-nav" : "")">
        <div class="container-fluid">
            <div class="row justify-content-between align-items-center w-100">

                <!-- Logo -->
                <div class="col-auto">
                    <a class="navbar-brand text-dark" href="@(User.IsInRole("Admin") ? "/Admin" : User.IsInRole("Employee") ? "/Employee" : "/Home")">
                        <a href="/">
    <img src="/images/kaira/main-logo-10.png" alt="logo" width="70" height="80">
</a>

                    </a>
                </div>

                <!-- Mobile Toggle -->
                <div class="col-auto">
                    <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar">
                        <i class="fas fa-bars"></i>
                    </button>

                    <!-- Mobile Menu -->
                    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
                        <div class="offcanvas-header">
                            <h5 class="offcanvas-title" id="offcanvasNavbarLabel">
                                <i class="fas fa-bars me-2"></i>Menu
                            </h5>
                            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                        </div>

                        <div class="offcanvas-body">
                            @if (User.IsInRole("Admin") || User.IsInRole("Employee"))
                            {
                                <!-- Admin/Employee Menu -->
                                <ul class="navbar-nav justify-content-center flex-grow-1 gap-1 gap-md-5 pe-3">
                                    <li class="nav-item">
                                        <a class="nav-link nav-link-enhanced" href="@(User.IsInRole("Admin") ? "/Admin" : "/Employee")">
                                            <i class="fas fa-tachometer-alt me-1 d-lg-none"></i>Dashboard
                                        </a>
                                    </li>
                                </ul>
                            }
                            else
                            {
                                <!-- Customer Menu -->
                                <ul class="navbar-nav justify-content-center flex-grow-1 gap-1 gap-md-5 pe-3">
                                    <li class="nav-item dropdown nav-item-enhanced">
                                        <a class="nav-link  nav-link-enhanced active" href="#" id="dropdownHome" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            <i class="fas fa-home me-1 d-lg-none"></i>Home
                                        </a>
                                    </li>
                                    <li class="nav-item nav-item-enhanced">
                                        <a class="nav-link nav-link-enhanced" href="#">
                                            <i class="fas fa-envelope me-1 d-lg-none"></i>Contacto
                                        </a>
                                    </li>
                                </ul>
                            }
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="col-auto">
                    <ul class="list-unstyled d-flex m-0 align-items-center gap-3">
                        @if (User.IsInRole("Admin") || User.IsInRole("Employee"))
                        {
                            <li class="d-none d-lg-block">
                                <a href="@(User.IsInRole("Admin") ? "/Admin" : "/Employee")" 
                                   class="panel-button @(User.IsInRole("Employee") ? "employee" : "")" 
                                   title="Panel de @(User.IsInRole("Admin") ? "Administración" : "Empleado")">
                                    <i class="fas fa-@(User.IsInRole("Admin") ? "shield-alt" : "user-tie")"></i>
                                    <span class="d-none d-xl-inline">Panel @(User.IsInRole("Admin") ? "Admin" : "Empleado")</span>
                                </a>
                            </li>
                        }
                        else
                        {
                            <li class="d-none d-lg-block">
                                <a id="btnOpenWishlist" href="#" class="text-uppercase mx-2 text-decoration-none nav-link-enhanced position-relative" title="Lista de deseos">
                                    <i class="fas fa-heart me-1"></i>Wishlist
                                    <span class="wishlist-count badge-enhanced">(0)</span>
                                </a>
                            </li>
                            <li class="d-none d-lg-block">
                                <a href="#" class="text-uppercase mx-2 text-decoration-none nav-link-enhanced position-relative"
                                   data-bs-toggle="offcanvas" data-bs-target="#offcanvasCart" aria-controls="offcanvasCart" title="Carrito" id="btnOpenCart">
                                    <i class="fas fa-shopping-cart me-1"></i>Cart
                                    <span class="cart-count badge-enhanced">(0)</span>
                                    <!-- total del carrito -->
                                    <span class="ms-1 cart-total-amount">$0.00</span>
                                </a>
                            </li>
                            <li class="d-lg-none">
                                <a href="#" class="nav-icon-enhanced" title="Lista de deseos" id="btnOpenWishlistMobile">
                                    <svg width="24" height="24" viewBox="0 0 24 24" class="mobile-icon-enhanced">
                                        <use xlink:href="#heart"></use>
                                    </svg>
                                </a>
                            </li>
                            <li class="d-lg-none">
                                <a href="#" class="nav-icon-enhanced" data-bs-toggle="offcanvas" data-bs-target="#offcanvasCart" aria-controls="offcanvasCart" title="Carrito" id="btnOpenCartMobile">
                                    <svg width="24" height="24" viewBox="0 0 24 24" class="mobile-icon-enhanced">
                                        <use xlink:href="#cart"></use>
                                    </svg>
                                    <span class="cart-count badge-enhanced ms-1">(0)</span>
                                </a>
                            </li>
                            <li class="search-box">
                                <a href="#" class="search-button nav-icon-enhanced" title="Buscar">
                                    <svg width="24" height="24" viewBox="0 0 24 24" class="mobile-icon-enhanced">
                                        <use xlink:href="#search"></use>
                                    </svg>
                                </a>
                            </li>
                        }

                        <li class="nav-item dropdown user-box">
                            @if (!User.Identity.IsAuthenticated)
                            {
                                <a class="nav-link nav-icon-enhanced user-button-enhanced" href="/Account" title="Mi cuenta">
                                    <svg width="24" height="24" viewBox="0 0 24 24" class="mobile-icon-enhanced">
                                        <use xlink:href="#user"></use>
                                    </svg>
                                </a>
                            }
                            else
                            {
                                <a class="nav-link nav-icon-enhanced dropdown-toggle user-button-enhanced" href="#" id="userMenu" role="button" data-bs-toggle="dropdown" aria-expanded="false" title="Mi cuenta">
                                    <svg width="24" height="24" viewBox="0 0 24 24" class="mobile-icon-enhanced">
                                        <use xlink:href="#user"></use>
                                    </svg>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-enhanced dropdown-menu-end" aria-labelledby="userMenu">
                                    @if (!User.IsInRole("Admin") && !User.IsInRole("Employee"))
                                    {
                                        <li>
                                            <a class="dropdown-item dropdown-item-enhanced" asp-controller="Account" asp-action="Profile">
                                                <i class="fas fa-user-edit me-2"></i>Editar perfil
                                            </a>
                                        </li>
                                        
                                        <li >
                                        <a class="dropdown-item dropdown-item-enhanced" href="@Url.Action("Index", "MyOrders")">
                                            <i class="fas fa-shopping-bag me-1"></i>Mis Pedidos
                                        </a>
                                    </li>
                                        
                                        <li><hr class="dropdown-divider" /></li>
                                    }
                                    else
                                    {
                                        
                                        
                                    }
                                    <li>
                                        <form method="post" action="/Account/Logout" class="px-3 py-1">
                                            @Html.AntiForgeryToken()
                                            <button class="btn btn-sm btn-outline-danger w-100" type="submit">
                                                <i class="fas fa-sign-out-alt me-2"></i>Cerrar sesión
                                            </button>
                                        </form>
                                    </li>
                                </ul>
                            }
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    @if (!User.IsInRole("Admin") && !User.IsInRole("Employee"))
    {
        <!-- Offcanvas del carrito (dinámico) -->
        <div class="offcanvas offcanvas-end" data-bs-scroll="true" tabindex="-1" id="offcanvasCart" aria-labelledby="offcanvasCartLabel">
            <div class="offcanvas-header border-bottom">
                <h5 class="offcanvas-title" id="offcanvasCartLabel">
                    <i class="fas fa-shopping-cart me-2"></i>Mi Carrito
                </h5>
                <button type="button" class="btn-close text-reset ms-auto" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>

            <!-- Aquí se carga /Cart/Drawer -->
            <div class="offcanvas-body" id="cart-drawer-container">
                <div class="text-center py-5">
                    <i class="fas fa-spinner fa-spin fa-2x text-muted mb-3"></i>
                    <div class="text-muted">Cargando carrito…</div>
                </div>
            </div>

            <div class="border-top p-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="fw-semibold">Total:</span>
                    <span class="fw-bold cart-total-amount fs-5">$0.00</span>
                </div>
                <button class="btn btn-success w-100 btn-lg" id="btnCartCheckout" type="button" disabled>
                    <i class="fas fa-credit-card me-2"></i>Comprar
                </button>
            </div>
        </div>
    }

    <div>
        @RenderBody()
    </div>

    <div id="wishlist-modal" class="modal fade" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content" id="wishlist-modal-content"></div>
      </div>
    </div>

    <!-- Modal de autenticación requerida -->
    <div class="modal fade" id="authRequiredModal" tabindex="-1" aria-labelledby="authRequiredModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-bottom-0">
                    <h5 class="modal-title" id="authRequiredModalLabel">
                        <i class="fas fa-exclamation-circle me-2 text-warning"></i>Acceso Requerido
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <div class="mb-3">
                        <i class="fas fa-user-lock fa-3x text-muted"></i>
                    </div>
                    <h6 class="mb-3">Solo disponible para usuarios registrados</h6>
                    <p class="text-muted mb-4">
                        Para acceder a esta función necesitas tener una cuenta activa en nuestra plataforma.
                    </p>
                </div>
                <div class="modal-footer border-top-0 justify-content-center">
                    <button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cerrar
                    </button>
                    <a href="/Account" class="btn btn-primary">
                        <i class="fas fa-user-plus me-1"></i>Crear Cuenta
                    </a>
                </div>
            </div>
        </div>
    </div>

    <footer id="footer" class="mt-5">
        <div class="footer-intro mb-4 text-center">
            <a href="/">
                <img src="~/images/kaira/main-logo-10.png" alt="Kaira Logo" class="img-fluid"  width="150" height="80"/>
            </a>
        </div>
    </footer>

    <script src="~/js/kaira/jquery.min.js" asp-append-version="true"></script>
    <script src="~/js/kaira/modernizr.js" asp-append-version="true"></script>
    <script src="~/js/kaira/plugins.js" asp-append-version="true"></script>
    <script src="~/js/kaira/SmoothScroll.js" asp-append-version="true"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.js"></script>
    <script src="~/js/kaira/script.min.js" asp-append-version="true"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>

    <script>
        // Efectos de navbar y dropdowns
        document.addEventListener('DOMContentLoaded', function () {
            const navbar = document.querySelector('.navbar-enhanced');
            window.addEventListener('scroll', function () {
                let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                if (scrollTop > 100) navbar.classList.add('scrolled'); else navbar.classList.remove('scrolled');
            });

            const dropdowns = document.querySelectorAll('.dropdown');
            dropdowns.forEach(dropdown => {
                const dropdownMenu = dropdown.querySelector('.dropdown-menu-enhanced');
                let timeoutId;
                if (dropdownMenu) {
                    dropdown.addEventListener('mouseenter', function () {
                        if (window.innerWidth >= 992) {
                            clearTimeout(timeoutId);
                            dropdownMenu.classList.add('show');
                        }
                    });
                    dropdown.addEventListener('mouseleave', function () {
                        if (window.innerWidth >= 992) {
                            timeoutId = setTimeout(() => dropdownMenu.classList.remove('show'), 100);
                        }
                    });
                }
            });

            const offcanvasNavbar = document.getElementById('offcanvasNavbar');
            const mobileDropdowns = offcanvasNavbar ? offcanvasNavbar.querySelectorAll('.dropdown-toggle') : [];
            mobileDropdowns.forEach(toggle => {
                toggle.addEventListener('click', function (e) {
                    if (window.innerWidth < 992) {
                        e.preventDefault();
                        const dropdownMenu = this.nextElementSibling;
                        const isOpen = dropdownMenu.style.display === 'block';
                        if (offcanvasNavbar) {
                            offcanvasNavbar.querySelectorAll('.dropdown-menu-enhanced').forEach(menu => { menu.style.display = 'none'; });
                        }
                        if (!isOpen) {
                            dropdownMenu.style.display = 'block';
                            dropdownMenu.style.animation = 'fadeInUp .3s ease';
                        }
                    }
                });
            });
        });
    </script>

    <!-- Wishlist (CORREGIDO - con manejo de usuarios no autenticados) -->
    <script>
    (function () {
        const metaToken = document.querySelector('meta[name="RequestVerificationToken"]');
        const XSRF = metaToken?.content || '';

        // Función para mostrar el modal de autenticación requerida
        function showAuthRequiredModal() {
            const modalEl = document.getElementById('authRequiredModal');
            if (modalEl && typeof bootstrap !== 'undefined') {
                const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                modal.show();
            }
        }

        // Verificar si el usuario está autenticado
        function isUserAuthenticated() {
            return @((User?.Identity?.IsAuthenticated ?? false).ToString().ToLower());
        }

        // 🔴 FUNCIÓN GLOBAL para actualizar el contador
        async function updateWishlistCount() {
            // Si no está autenticado, no intentar cargar el contador
            if (!isUserAuthenticated()) {
                document.querySelectorAll('.wishlist-count').forEach(el => {
                    el.textContent = '(0)';
                });
                return;
            }

            try {
                const resp = await fetch('/Wishlist/Count', { credentials: 'same-origin' });
                if (!resp.ok) return;
                const data = await resp.json();
                
                document.querySelectorAll('.wishlist-count').forEach(el => {
                    el.textContent = `(${data.count || 0})`;
                });
                
                const badge = document.getElementById('js-wishlist-count');
                if (badge) {
                    badge.textContent = data.count || 0;
                    badge.style.display = (data.count > 0) ? 'inline-block' : 'none';
                }
            } catch (err) {
                console.error('Error al actualizar wishlist count:', err);
            }
        }

        async function loadWishlistDrawer() {
            if (!isUserAuthenticated()) {
                showAuthRequiredModal();
                return;
            }

            try {
                const resp = await fetch('/Wishlist/Drawer', { credentials: 'same-origin' });
                if (resp.status === 401) {
                    showAuthRequiredModal();
                    return;
                }
                const html = await resp.text();
                const container = document.getElementById('wishlist-modal-content');
                if (container) {
                    container.innerHTML = html;
                    bindWishlistRemoveButtons(container);
                }
            } catch (err) {
                console.error('Error al cargar wishlist drawer:', err);
            }
        }

        function bindWishlistRemoveButtons(container) {
            container.querySelectorAll('.js-wishlist-remove').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    if (!isUserAuthenticated()) {
                        showAuthRequiredModal();
                        return;
                    }

                    const pid = parseInt(btn.getAttribute('data-product-id'), 10);
                    if (!pid) return;

                    const r = await fetch('/Wishlist/Remove', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': XSRF
                        },
                        body: JSON.stringify({ productId: pid })
                    });

                    if (r.ok) {
                        await loadWishlistDrawer();
                        await updateWishlistCount();
                    }
                });
            });
        }

        async function openWishlistModal() {
            if (!isUserAuthenticated()) {
                showAuthRequiredModal();
                return;
            }
            await loadWishlistDrawer();
            const modalEl = document.getElementById('wishlist-modal');
            if (modalEl && typeof bootstrap !== 'undefined') {
                const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                modal.show();
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            updateWishlistCount();

            // Wishlist - Desktop
            const btn = document.getElementById('btnOpenWishlist');
            if (btn) {
                btn.addEventListener('click', function (e) {
                    e.preventDefault();
                    openWishlistModal();
                });
            }

            // Wishlist - Mobile
            const mobileWishlistBtn = document.getElementById('btnOpenWishlistMobile');
            if (mobileWishlistBtn) {
                mobileWishlistBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    openWishlistModal();
                });
            }

            // Botón alternativo si existe
            const btnAlt = document.getElementById('js-wishlist-open');
            if (btnAlt) {
                btnAlt.addEventListener('click', function (e) {
                    e.preventDefault();
                    openWishlistModal();
                });
            }
        });

        // === Wishlist AJAX (CORREGIDO) ===
        (function () {
            async function postJson(url, data) {
                if (!isUserAuthenticated()) {
                    showAuthRequiredModal();
                    return null;
                }

                const resp = await fetch(url, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': XSRF },
                    body: JSON.stringify(data || {})
                });
                
                if (resp.status === 401) {
                    showAuthRequiredModal();
                    return null;
                }
                
                try { return await resp.json(); } catch { return null; }
            }

            function markActive(btn) {
                btn.classList.add('active');
                btn.setAttribute('aria-pressed', 'true');
                const i = btn.querySelector('i.fas.fa-heart');
                if (i) i.classList.add('text-danger');
            }

            document.querySelectorAll('.js-add-wishlist').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    
                    if (!isUserAuthenticated()) {
                        showAuthRequiredModal();
                        return;
                    }
                    
                    const pid = parseInt(btn.getAttribute('data-product-id'), 10);
                    if (!pid) return;
                    
                    const res = await postJson('/Wishlist/Add', { productId: pid });
                    
                    if (res && res.ok) {
                        markActive(btn);
                        await updateWishlistCount();
                        console.log('✅ Producto agregado a wishlist');
                    }
                });
            });
        })();
    })();
    </script>

    <!-- 🛒 Carrito: helpers globales (CORREGIDO con manejo de autenticación) -->
    <script>
    (function () {
        const metaToken = document.querySelector('meta[name="RequestVerificationToken"]');
        const XSRF = metaToken?.content || '';

        // Función para mostrar el modal de autenticación requerida
        function showAuthRequiredModal() {
            const modalEl = document.getElementById('authRequiredModal');
            if (modalEl && typeof bootstrap !== 'undefined') {
                const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                modal.show();
            }
        }

        // Verificar si el usuario está autenticado
        function isUserAuthenticated() {
            return @((User?.Identity?.IsAuthenticated ?? false).ToString().ToLower());
        }

        async function getCartSummary() {
            if (!isUserAuthenticated()) {
                return { count: 0, total: 0, totalFormatted: '$0.00', hasItems: false };
            }

            try {
                const r = await fetch('/Cart/Summary', { credentials: 'same-origin' });
                if (!r.ok) return null;
                return await r.json();
            } catch { 
                return { count: 0, total: 0, totalFormatted: '$0.00', hasItems: false };
            }
        }

        async function refreshCartBadges() {
            const s = await getCartSummary();
            if (!s) return;

            document.querySelectorAll('.cart-count').forEach(el => el.textContent = `(${s.count ?? 0})`);

            const formatted = s.totalFormatted ??
                new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(s.total ?? 0);

            document.querySelectorAll('.cart-total-amount').forEach(el => el.textContent = formatted);

            const btnBuy = document.getElementById('btnCartCheckout');
            if (btnBuy) btnBuy.disabled = !(s.hasItems ?? (s.count > 0));
        }

        function bindCartDrawerEvents(container) {
            if (!container) return;

            container.querySelectorAll('.js-cart-remove').forEach(btn => {
                btn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    
                    if (!isUserAuthenticated()) {
                        showAuthRequiredModal();
                        return;
                    }

                    const id = this.getAttribute('data-cart-item-id');
                    if (!id) return;
                    
                    try {
                        const r = await fetch('/Cart/Remove', {
                            method: 'POST',
                            credentials: 'same-origin',
                            headers: { 
                                'Content-Type': 'application/json', 
                                'RequestVerificationToken': XSRF 
                            },
                            body: JSON.stringify({ cartItemId: parseInt(id, 10) })
                        });
                        
                        const data = await r.json();
                        if (data.ok) {
                            await loadCartDrawer();
                        } else {
                            alert(data.message || 'Error al eliminar');
                        }
                    } catch (err) {
                        alert('Error de conexión');
                        console.error(err);
                    }
                });
            });

            const clearBtn = container.querySelector('.js-cart-clear');
            if (clearBtn) {
                clearBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    
                    if (!isUserAuthenticated()) {
                        showAuthRequiredModal();
                        return;
                    }

                    if (!confirm('¿Vaciar todo el carrito?')) return;
                    
                    try {
                        const r = await fetch('/Cart/Clear', {
                            method: 'POST',
                            credentials: 'same-origin',
                            headers: { 'RequestVerificationToken': XSRF }
                        });
                        
                        if (r.ok) await loadCartDrawer();
                        else alert('Error al vaciar carrito');
                    } catch (err) {
                        alert('Error de conexión');
                        console.error(err);
                    }
                });
            }
        }

        async function loadCartDrawer() {
            if (!isUserAuthenticated()) {
                showAuthRequiredModal();
                return;
            }

            try {
                const r = await fetch('/Cart/Drawer', { credentials: 'same-origin' });
                if (r.status === 401) {
                    showAuthRequiredModal();
                    return;
                }
                const html = await r.text();
                const container = document.getElementById('cart-drawer-container');
                if (container) {
                    container.innerHTML = html;
                    bindCartDrawerEvents(container);
                }
            } catch {
                const container = document.getElementById('cart-drawer-container');
                if (container) {
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-triangle-exclamation text-warning fa-2x mb-2"></i>
                            <div class="text-muted">No se pudo cargar el carrito.</div>
                        </div>`;
                }
            } finally {
                refreshCartBadges();
            }
        }

        // Función para abrir carrito con verificación de autenticación
        function openCartWithAuthCheck() {
            if (!isUserAuthenticated()) {
                showAuthRequiredModal();
                return false;
            }
            return true;
        }

        window.refreshCartBadges = refreshCartBadges;
        window.loadCartDrawer = loadCartDrawer;
        window.updateCartCount = refreshCartBadges;

        window.openCartAfterAdd = async function () {
            if (!openCartWithAuthCheck()) return;
            
            await loadCartDrawer();
            const offcanvasEl = document.getElementById('offcanvasCart');
            if (offcanvasEl && typeof bootstrap !== 'undefined') {
                bootstrap.Offcanvas.getOrCreateInstance(offcanvasEl).show();
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const isAdminOrEmployee = document.querySelector('.admin-nav, .employee-nav');
            if (!isAdminOrEmployee) {
                refreshCartBadges();
            }

            // Manejar clics en botones del carrito con verificación de autenticación
            document.querySelectorAll('[data-bs-target="#offcanvasCart"]').forEach(b => {
                b.addEventListener('click', function(e) {
                    if (!openCartWithAuthCheck()) {
                        e.preventDefault();
                        return;
                    }
                    loadCartDrawer();
                });
            });

            const btnCheckout = document.getElementById('btnCartCheckout');
            if (btnCheckout) {
                btnCheckout.addEventListener('click', () => {
                    if (!isUserAuthenticated()) {
                        showAuthRequiredModal();
                        return;
                    }
                    window.location.href = '@Url.Action("CheckoutFromCart", "Orders")';
                });
            }
        });
    })();
    </script>

    @RenderSection("Scripts", required: false)
</body>
</html>