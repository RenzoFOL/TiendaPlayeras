@model Order
@{
    ViewData["Title"] = $"Pedido #{Model.OrderNumber}";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Pedido @Model.OrderNumber</h2>
        <a href="@Url.Action("Index")" class="btn btn-outline-secondary">Volver</a>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success">@TempData["SuccessMessage"]</div>
    }

    <div class="row">
        <!-- Información del pedido -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Información del Pedido</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">Número de Orden:</dt>
                        <dd class="col-sm-8"><strong>@Model.OrderNumber</strong></dd>

                        <dt class="col-sm-4">Cliente:</dt>
                        <dd class="col-sm-8">@Model.UserName</dd>

                        <dt class="col-sm-4">Total de Productos:</dt>
                        <dd class="col-sm-8">@Model.TotalItems producto(s)</dd>

                        <dt class="col-sm-4">Subtotal:</dt>
                        <dd class="col-sm-8">@Model.Subtotal.ToString("C")</dd>

                        <dt class="col-sm-4">Envío:</dt>
                        <dd class="col-sm-8">@Model.Shipping.ToString("C")</dd>

                        <dt class="col-sm-4">Total:</dt>
                        <dd class="col-sm-8"><strong>@Model.Total.ToString("C")</strong></dd>

                        <dt class="col-sm-4">Punto de Entrega:</dt>
                        <dd class="col-sm-8">@Model.DeliveryPoint</dd>

                        <dt class="col-sm-4">Horario:</dt>
                        <dd class="col-sm-8">@Model.DeliverySchedule</dd>

                        <dt class="col-sm-4">Método de Pago:</dt>
                        <dd class="col-sm-8">@Model.PaymentMethod</dd>

                        <dt class="col-sm-4">Estado:</dt>
                        <dd class="col-sm-8">
                            <span class="badge @GetStatusBadgeClass(Model.Status)">
                                @Model.StatusDisplay
                            </span>
                        </dd>

                        <dt class="col-sm-4">Fecha:</dt>
                        <dd class="col-sm-8">@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</dd>
                    </dl>
                </div>
            </div>

            <!-- Productos del pedido -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Productos del Pedido</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Talla</th>
                                    <th class="text-center">Cantidad</th>
                                    <th class="text-end">Precio</th>
                                    <th class="text-end">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.Items)
                                {
                                    <tr>
                                        <td>@item.ProductName</td>
                                        <td>@item.Size</td>
                                        <td class="text-center">@item.Quantity</td>
                                        <td class="text-end">@item.UnitPrice.ToString("C")</td>
                                        <td class="text-end">@item.TotalPrice.ToString("C")</td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="4" class="text-end"><strong>Total:</strong></td>
                                    <td class="text-end"><strong>@Model.Total.ToString("C")</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gestión de Estado -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Actualizar Estado</h5>
                </div>
                <div class="card-body">
                    <form method="post" asp-action="UpdateStatus" asp-route-id="@Model.Id">
                        @Html.AntiForgeryToken()
                        <div class="mb-3">
                            <label for="newStatus" class="form-label">Nuevo Estado</label>
                            <select name="newStatus" id="newStatus" class="form-select" required>
                                @foreach (var status in OrderStatus.GetAllStatuses())
                                {
                                    <option value="@status" selected="@(status == Model.Status)">
                                        @OrderStatus.GetDisplayName(status)
                                    </option>
                                }
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="notes" class="form-label">Notas (opcional)</label>
                            <textarea name="notes" id="notes" class="form-control" rows="3" 
                                      placeholder="Agregar notas sobre el cambio de estado..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Actualizar Estado</button>
                    </form>
                </div>
            </div>

            <!-- Información adicional -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Información Adicional</h5>
                </div>
                <div class="card-body">
                    <p><strong>ID del Pedido:</strong> @Model.Id</p>
                    <p><strong>Usuario ID:</strong> @Model.UserId</p>
                    <p><strong>Actualizado:</strong> @Model.UpdatedAt.ToString("dd/MM/yyyy HH:mm")</p>
                    <p><strong>Estado:</strong> @Model.Status</p>
                </div>
            </div>

            <!-- Acciones rápidas -->
            
        </div>
    </div>
</div>

@section Scripts {
<script>
    // Cargar historial de estados (si existe el endpoint)
    $(document).ready(function() {
        // Solo cargar historial si el endpoint existe para Orders
        // loadStatusHistory(@Model.Id);
    });

    function updateStatus(status) {
        if (confirm('¿Estás seguro de que quieres cambiar el estado a "' + status + '"?')) {
            document.getElementById('newStatus').value = status;
            document.querySelector('form').submit();
        }
    }

    // Función para cargar historial (mantener por compatibilidad)
    function loadStatusHistory(orderId) {
        $.get('@Url.Action("GetStatusHistory", "AdminOrders")/' + orderId, function(data) {
            var html = '';
            if (data.length === 0) {
                html = '<p class="text-muted">No hay historial disponible</p>';
            } else {
                html = '<div class="timeline">';
                data.forEach(function(entry, index) {
                    html += `
                        <div class="timeline-item ${index === 0 ? 'current' : ''}">
                            <div class="timeline-marker"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">${entry.status}</h6>
                                <p class="mb-1 text-muted small">Por: ${entry.changedBy}</p>
                                <p class="mb-1 text-muted small">${new Date(entry.changedAt).toLocaleString()}</p>
                                ${entry.notes ? `<p class="mb-0">${entry.notes}</p>` : ''}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            $('#statusHistory').html(html);
        }).fail(function() {
            $('#statusHistory').html('<p class="text-muted">Historial no disponible</p>');
        });
    }
</script>

<style>
    .timeline {
        position: relative;
        padding-left: 20px;
    }
    
    .timeline-item {
        position: relative;
        padding-bottom: 20px;
        border-left: 2px solid #dee2e6;
    }
    
    .timeline-item.current {
        border-left-color: #0d6efd;
    }
    
    .timeline-marker {
        position: absolute;
        left: -7px;
        top: 0;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #dee2e6;
    }
    
    .timeline-item.current .timeline-marker {
        background: #0d6efd;
    }
    
    .timeline-content {
        margin-left: 15px;
    }
</style>
}

@functions {
    string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Pending" => "bg-warning",
            "Confirmed" => "bg-info",
            "InProgress" => "bg-primary",
            "ReadyForPickup" => "bg-success",
            "Completed" => "bg-secondary",
            "Cancelled" => "bg-danger",
            _ => "bg-light text-dark"
        };
    }
}