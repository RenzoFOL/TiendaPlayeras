@model OrderTicket
@{
    ViewData["Title"] = $"Pedido #{Model.Id}";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Pedido #@Model.Id</h2>
        <a href="@Url.Action("Index")" class="btn btn-outline-secondary">Volver</a>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success">@TempData["SuccessMessage"]</div>
    }

    <div class="row">
        <!-- Información del pedido -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Información del Pedido</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">Producto:</dt>
                        <dd class="col-sm-8">@Model.ProductName</dd>

                        <dt class="col-sm-4">Talla:</dt>
                        <dd class="col-sm-8">@Model.Size</dd>

                        <dt class="col-sm-4">Cantidad:</dt>
                        <dd class="col-sm-8">@Model.Quantity</dd>

                        <dt class="col-sm-4">Precio Unitario:</dt>
                        <dd class="col-sm-8">@Model.UnitPrice.ToString("C")</dd>

                        <dt class="col-sm-4">Total:</dt>
                        <dd class="col-sm-8"><strong>@Model.TotalPrice.ToString("C")</strong></dd>

                        <dt class="col-sm-4">Cliente:</dt>
                        <dd class="col-sm-8">@Model.UserName</dd>

                        <dt class="col-sm-4">Punto de Entrega:</dt>
                        <dd class="col-sm-8">@Model.DeliveryPoint</dd>

                        <dt class="col-sm-4">Horario:</dt>
                        <dd class="col-sm-8">@Model.DeliverySchedule</dd>

                        <dt class="col-sm-4">Método de Pago:</dt>
                        <dd class="col-sm-8">@Model.PaymentMethod</dd>

                        <dt class="col-sm-4">Fecha:</dt>
                        <dd class="col-sm-8">@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</dd>
                    </dl>
                </div>
            </div>

            <!-- Ticket PDF -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Ticket</h5>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(Model.PdfFileName))
                    {
                        <a href="~/tickets/@Model.PdfFileName" target="_blank" class="btn btn-primary">
                            <i class="fas fa-download"></i> Descargar Ticket PDF
                        </a>
                    }
                    else
                    {
                        <span class="text-muted">No hay ticket disponible</span>
                    }
                </div>
            </div>
        </div>

        <!-- Gestión de Estado -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Actualizar Estado</h5>
                </div>
                <div class="card-body">
                    <form method="post" asp-action="UpdateStatus" asp-route-id="@Model.Id">
                        @Html.AntiForgeryToken()
                        <div class="mb-3">
                            <label for="newStatus" class="form-label">Nuevo Estado</label>
                            <select name="newStatus" id="newStatus" class="form-select" required>
                                @foreach (var status in OrderStatus.GetAllStatuses())
                                {
                                    <option value="@status" selected="@(status == Model.Status)">
                                        @OrderStatus.GetDisplayName(status)
                                    </option>
                                }
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="notes" class="form-label">Notas (opcional)</label>
                            <textarea name="notes" id="notes" class="form-control" rows="3" 
                                      placeholder="Agregar notas sobre el cambio de estado..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Actualizar Estado</button>
                    </form>
                </div>
            </div>

            <!-- Historial de Estados -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Historial de Estados</h5>
                </div>
                <div class="card-body">
                    <div id="statusHistory">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    // Cargar historial de estados
    $(document).ready(function() {
        loadStatusHistory(@Model.Id);
    });

    function loadStatusHistory(orderId) {
        $.get('@Url.Action("GetStatusHistory")/' + orderId, function(data) {
            var html = '';
            if (data.length === 0) {
                html = '<p class="text-muted">No hay historial disponible</p>';
            } else {
                html = '<div class="timeline">';
                data.forEach(function(entry, index) {
                    html += `
                        <div class="timeline-item ${index === 0 ? 'current' : ''}">
                            <div class="timeline-marker"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">${entry.status}</h6>
                                <p class="mb-1 text-muted small">Por: ${entry.changedBy}</p>
                                <p class="mb-1 text-muted small">${new Date(entry.changedAt).toLocaleString()}</p>
                                ${entry.notes ? `<p class="mb-0">${entry.notes}</p>` : ''}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            $('#statusHistory').html(html);
        });
    }
</script>

<style>
    .timeline {
        position: relative;
        padding-left: 20px;
    }
    
    .timeline-item {
        position: relative;
        padding-bottom: 20px;
        border-left: 2px solid #dee2e6;
    }
    
    .timeline-item.current {
        border-left-color: #0d6efd;
    }
    
    .timeline-marker {
        position: absolute;
        left: -7px;
        top: 0;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #dee2e6;
    }
    
    .timeline-item.current .timeline-marker {
        background: #0d6efd;
    }
    
    .timeline-content {
        margin-left: 15px;
    }
</style>
}