@model IEnumerable<TiendaPlayeras.Web.Models.Tag>
@{
    ViewData["Title"] = "Gestión de Categorías y Etiquetas";
    var cats = (List<TiendaPlayeras.Web.Models.Category>)ViewBag.Categories;
    int? catId = ViewBag.CategoryId as int?;
    string q = ViewBag.Q as string ?? "";
    string catSearch = ViewBag.CategorySearch as string ?? "";
    
    // Paginación de categorías
    int catPage = ViewBag.CategoryPage ?? 1;
    int catPageSize = 5;
    var catsFiltered = cats.AsEnumerable();
    if (!string.IsNullOrWhiteSpace(catSearch))
    {
        catsFiltered = catsFiltered.Where(c => c.Name.Contains(catSearch, StringComparison.OrdinalIgnoreCase) || 
                                                c.Slug.Contains(catSearch, StringComparison.OrdinalIgnoreCase));
    }
    var catsPaged = catsFiltered.Skip((catPage - 1) * catPageSize).Take(catPageSize).ToList();
    int catTotalPages = (int)Math.Ceiling(catsFiltered.Count() / (double)catPageSize);
    
    // Paginación de etiquetas
    int tagPage = ViewBag.TagPage ?? 1;
    int tagPageSize = 5;
    var tagsPaged = Model.Skip((tagPage - 1) * tagPageSize).Take(tagPageSize).ToList();
    int tagTotalPages = (int)Math.Ceiling(Model.Count() / (double)tagPageSize);
}
<link rel="stylesheet" href="~/css/kaira/Tag-eti.css">


<div class="tags-container">
    <div class="container-fluid">
        <!-- Header -->
        <div class="page-header">
            <h1>
                <i class="fas fa-tags"></i>
                Gestión de Categorías y Etiquetas
            </h1>
        </div>

        <!-- ============ LAYOUT HORIZONTAL: CATEGORÍAS IZQUIERDA - ETIQUETAS DERECHA ============ -->
<div class="container-fluid">
    <div class="row">
        <!-- ============ COLUMNA IZQUIERDA: CATEGORÍAS ============ -->
        <div class="col-lg-6">
            <div class="section-block">
                <div class="section-title">
                    <i class="fas fa-folder"></i>
                    <h2>Categorías</h2>
                </div>

                <div class="row">
                    <!-- Formulario Crear Categoría -->
                    <div class="col-lg-12">
                        <div class="premium-card mb-3">
                            <div class="card-header-premium">
                                <h5>
                                    <i class="fas fa-folder-plus"></i>
                                    Crear Categoría
                                </h5>
                            </div>
                            <div class="card-body-premium">
                                <form asp-action="CreateCategory" method="post" class="form-create">
                                    @Html.AntiForgeryToken()
                                    <div class="mb-3">
                                        <label class="form-label">Nombre de la Categoría</label>
                                        <input type="text" name="name" class="form-control" placeholder="Ej: Música, Deportes..." required />
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Descripción (opcional)</label>
                                        <textarea name="description" class="form-control" rows="3" placeholder="Descripción opcional..."></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-create w-100">
                                        <i class="fas fa-plus me-2"></i>Crear Categoría
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Buscador y Tabla de Categorías -->
                    <div class="col-lg-12">
                        <!-- Buscador -->
                        <div class="premium-card mb-3">
                            <div class="card-body-premium">
                                <form method="get" action="@Url.Action("Tags")" class="search-form">
                                    <input type="hidden" name="categoryId" value="@catId" />
                                    <input type="hidden" name="q" value="@q" />
                                    <input type="hidden" name="tagPage" value="@tagPage" />
                                    <div class="input-group">
                                        <span class="input-group-text bg-white">
                                            <i class="fas fa-search text-primary"></i>
                                        </span>
                                        <input type="text" name="categorySearch" value="@catSearch" class="form-control" placeholder="Buscar categorías por nombre o slug..." />
                                        <button type="submit" class="btn btn-filter">
                                            <i class="fas fa-search me-2"></i>Buscar
                                        </button>
                                        @if (!string.IsNullOrWhiteSpace(catSearch))
                                        {
                                            <a href="@Url.Action("Tags", new { categoryId = catId, q = q, tagPage = tagPage })" class="btn btn-outline-secondary">
                                                <i class="fas fa-times"></i>
                                            </a>
                                        }
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Tabla de Categorías -->
                        <div class="premium-card">
                            <div class="card-header-premium">
                                <h5>
                                    <i class="fas fa-list"></i>
                                    Lista de Categorías (@catsFiltered.Count())
                                </h5>
                            </div>
                            @if (!catsPaged.Any())
                            {
                                <div class="empty-state">
                                    <i class="fas fa-folder-open fa-4x"></i>
                                    <h5>No hay categorías</h5>
                                    <p>@(string.IsNullOrWhiteSpace(catSearch) ? "Crea tu primera categoría usando el formulario." : "No se encontraron categorías con ese criterio.")</p>
                                </div>
                            }
                            else
                            {
                                <div class="table-responsive">
                                    <table class="table table-premium">
                                        <thead>
                                            <tr>
                                                <th>Categoría</th>
                                                <th style="width:100px;">Etiquetas</th>
                                                <th style="width:100px;">Estado</th>
                                                <th style="width:120px;">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var cat in catsPaged)
                                            {
                                                <tr>
                                                    <td>
                                                        <div class="category-name">@cat.Name</div>
                                                        <div class="category-slug">@cat.Slug</div>
                                                        @if (!string.IsNullOrEmpty(cat.Description))
                                                        {
                                                            <small class="text-muted">@cat.Description</small>
                                                        }
                                                    </td>
                                                    <td>
                                                        <span class="badge-premium badge-primary">
                                                            <i class="fas fa-tags"></i>
                                                            @cat.Tags.Count
                                                        </span>
                                                    </td>
                                                    <td>
                                                        @if (cat.IsActive)
                                                        {
                                                            <span class="badge-premium badge-success">
                                                                <i class="fas fa-check-circle"></i>
                                                                Activa
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge-premium badge-secondary">
                                                                <i class="fas fa-times-circle"></i>
                                                                Inactiva
                                                            </span>
                                                        }
                                                    </td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm">
                                                            <button type="button" class="btn btn-outline-primary btn-action" 
                                                                    data-bs-toggle="modal" data-bs-target="#editCategoryModal"
                                                                    data-cat-id="@cat.Id" 
                                                                    data-cat-name="@cat.Name"
                                                                    data-cat-description="@cat.Description"
                                                                    title="Editar">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                            <form asp-action="ToggleCategory" method="post" style="display:inline;">
                                                                @Html.AntiForgeryToken()
                                                                <input type="hidden" name="id" value="@cat.Id" />
                                                                <button type="submit" 
                                                                        class="btn btn-outline-@(cat.IsActive ? "warning" : "success") btn-action"
                                                                        onclick="return confirm('¿Estás seguro de que deseas @(cat.IsActive ? "desactivar" : "activar") la categoría @cat.Name?');"
                                                                        title="@(cat.IsActive ? "Desactivar" : "Activar")">
                                                                    <i class="fas fa-@(cat.IsActive ? "eye-slash" : "eye")"></i>
                                                                </button>
                                                            </form>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Paginación Categorías -->
                                @if (catTotalPages > 1)
                                {
                                    <div class="pagination-container">
                                        <nav>
                                            <ul class="pagination pagination-premium">
                                                <li class="page-item @(catPage == 1 ? "disabled" : "")">
                                                    <a class="page-link" href="@Url.Action("Tags", new { categoryId = catId, q = q, categorySearch = catSearch, catPage = catPage - 1, tagPage = tagPage })">
                                                        <i class="fas fa-chevron-left"></i>
                                                    </a>
                                                </li>
                                                @for (int i = 1; i <= catTotalPages; i++)
                                                {
                                                    <li class="page-item @(catPage == i ? "active" : "")">
                                                        <a class="page-link" href="@Url.Action("Tags", new { categoryId = catId, q = q, categorySearch = catSearch, catPage = i, tagPage = tagPage })">@i</a>
                                                    </li>
                                                }
                                                <li class="page-item @(catPage == catTotalPages ? "disabled" : "")">
                                                    <a class="page-link" href="@Url.Action("Tags", new { categoryId = catId, q = q, categorySearch = catSearch, catPage = catPage + 1, tagPage = tagPage })">
                                                        <i class="fas fa-chevron-right"></i>
                                                    </a>
                                                </li>
                                            </ul>
                                        </nav>
                                        <div class="pagination-info">
                                            Mostrando página @catPage de @catTotalPages (@catsFiltered.Count() categorías)
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============ COLUMNA DERECHA: ETIQUETAS ============ -->
        <div class="col-lg-6">
            <div class="section-block">
                <div class="section-title">
                    <i class="fas fa-tags"></i>
                    <h2>Etiquetas</h2>
                </div>

                <div class="row">
                    <!-- Formulario Crear Etiqueta -->
                    <div class="col-lg-12">
                        <div class="premium-card mb-3">
                            <div class="card-header-premium">
                                <h5>
                                    <i class="fas fa-plus-circle"></i>
                                    Crear Nueva Etiqueta
                                </h5>
                            </div>
                            <div class="card-body-premium">
                                <form asp-action="CreateTagInline" method="post" class="form-create">
                                    @Html.AntiForgeryToken()
                                    <div class="mb-3">
                                        <label class="form-label">Categoría</label>
                                        <select name="categoryId" class="form-select" required>
                                            <option value="">Seleccionar...</option>
                                            @foreach (var c in cats.Where(c => c.IsActive))
                                            { 
                                                <option value="@c.Id" selected="@(catId == c.Id)">@c.Name</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Nombre de Etiqueta</label>
                                        <input type="text" name="name" class="form-control" placeholder="Ej: Rock, Fútbol..." required />
                                    </div>
                                    <button type="submit" class="btn btn-create w-100">
                                        <i class="fas fa-plus me-2"></i>Crear Etiqueta
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Filtros y Tabla de Etiquetas -->
                    <div class="col-lg-12">
                        <!-- Filtros -->
                        <div class="premium-card mb-3">
                            <div class="card-body-premium">
                                <form method="get" action="@Url.Action("Tags")" class="row g-3">
                                    <input type="hidden" name="categorySearch" value="@catSearch" />
                                    <input type="hidden" name="catPage" value="@catPage" />
                                    <div class="col-md-6">
                                        <label class="form-label">Filtrar por Categoría</label>
                                        <select name="categoryId" class="form-select" onchange="this.form.submit()">
                                            <option value="">Todas las categorías</option>
                                            @foreach (var c in cats)
                                            {
                                                <option value="@c.Id" selected="@(catId == c.Id)">@c.Name</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Buscar Etiqueta</label>
                                        <div class="input-group">
                                            <input type="text" name="q" value="@q" class="form-control" placeholder="Nombre..." />
                                            <button type="submit" class="btn btn-filter">
                                                <i class="fas fa-search"></i>
                                            </button>
                                            @if (!string.IsNullOrWhiteSpace(q))
                                            {
                                                <a href="@Url.Action("Tags", new { categoryId = catId, categorySearch = catSearch, catPage = catPage })" class="btn btn-outline-secondary">
                                                    <i class="fas fa-times"></i>
                                                </a>
                                            }
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Tabla de Etiquetas -->
                        <div class="premium-card">
                            <div class="card-header-premium">
                                <h5>
                                    <i class="fas fa-tags"></i>
                                    Lista de Etiquetas (@Model.Count())
                                </h5>
                            </div>
                            @if (!tagsPaged.Any())
                            {
                                <div class="empty-state">
                                    <i class="fas fa-tags fa-4x"></i>
                                    <h5>No se encontraron etiquetas</h5>
                                    <p>@(string.IsNullOrEmpty(q) ? "Crea tu primera etiqueta usando el formulario." : "No hay etiquetas que coincidan con tu búsqueda.")</p>
                                </div>
                            }
                            else
                            {
                                <div class="table-responsive">
                                    <table class="table table-premium">
                                        <thead>
                                            <tr>
                                                <th style="width:60px;">ID</th>
                                                <th>Categoría</th>
                                                <th>Nombre</th>
                                                <th style="width:90px;">Estado</th>
                                                <th style="width:120px;">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var t in tagsPaged)
                                            {
                                                <tr>
                                                    <td>
                                                        <span class="badge-premium badge-id">#@t.Id</span>
                                                    </td>
                                                    <td>
                                                        <span class="badge-premium badge-primary">@t.Category?.Name</span>
                                                    </td>
                                                    <td>
                                                        <div>
                                                            <strong style="color:#2d3748;">@t.Name</strong>
                                                            <div class="category-slug">@t.Slug</div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        @if (t.IsActive)
                                                        {
                                                            <span class="badge-premium badge-success">
                                                                <i class="fas fa-check-circle"></i>
                                                                Activa
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge-premium badge-secondary">
                                                                <i class="fas fa-times-circle"></i>
                                                                Inactiva
                                                            </span>
                                                        }
                                                    </td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm">
                                                            <button type="button" class="btn btn-outline-primary btn-action" 
                                                                    data-bs-toggle="modal" data-bs-target="#editTagModal" 
                                                                    data-tag-id="@t.Id" 
                                                                    data-tag-name="@t.Name" 
                                                                    data-category-id="@t.CategoryId"
                                                                    title="Editar">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                            <form asp-action="ToggleTag" method="post" style="display:inline;">
                                                                @Html.AntiForgeryToken()
                                                                <input type="hidden" name="id" value="@t.Id" />
                                                                <button type="submit" 
                                                                        class="btn btn-outline-@(t.IsActive ? "warning" : "success") btn-action"
                                                                        onclick="return confirm('¿Estás seguro de que deseas @(t.IsActive ? "desactivar" : "activar") la etiqueta @t.Name?');"
                                                                        title="@(t.IsActive ? "Desactivar" : "Activar")">
                                                                    <i class="fas fa-@(t.IsActive ? "eye-slash" : "eye")"></i>
                                                                </button>
                                                            </form>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Paginación Etiquetas -->
                                @if (tagTotalPages > 1)
                                {
                                    <div class="pagination-container">
                                        <nav>
                                            <ul class="pagination pagination-premium">
                                                <li class="page-item @(tagPage == 1 ? "disabled" : "")">
                                                    <a class="page-link" href="@Url.Action("Tags", new { categoryId = catId, q = q, categorySearch = catSearch, catPage = catPage, tagPage = tagPage - 1 })">
                                                        <i class="fas fa-chevron-left"></i>
                                                    </a>
                                                </li>
                                                @for (int i = 1; i <= tagTotalPages; i++)
                                                {
                                                    <li class="page-item @(tagPage == i ? "active" : "")">
                                                        <a class="page-link" href="@Url.Action("Tags", new { categoryId = catId, q = q, categorySearch = catSearch, catPage = catPage, tagPage = i })">@i</a>
                                                    </li>
                                                }
                                                <li class="page-item @(tagPage == tagTotalPages ? "disabled" : "")">
                                                    <a class="page-link" href="@Url.Action("Tags", new { categoryId = catId, q = q, categorySearch = catSearch, catPage = catPage, tagPage = tagPage + 1 })">
                                                        <i class="fas fa-chevron-right"></i>
                                                    </a>
                                                </li>
                                            </ul>
                                        </nav>
                                        <div class="pagination-info">
                                            Mostrando página @tagPage de @tagTotalPages (@Model.Count() etiquetas)
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Editar Categoría -->
<div class="modal fade" id="editCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit"></i>
                    Editar Categoría
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" asp-action="EditCategory">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" id="editCatId" />
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nombre</label>
                        <input type="text" name="name" class="form-control" id="editCatName" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripción (opcional)</label>
                        <textarea name="description" class="form-control" id="editCatDescription" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-modal-cancel" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-modal-save">
                        <i class="fas fa-save me-2"></i>Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar Etiqueta -->
<div class="modal fade" id="editTagModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit"></i>
                    Editar Etiqueta
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" asp-action="EditTag">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" id="editTagId" />
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Categoría</label>
                        <select name="categoryId" class="form-select" id="editCategoryId" required>
                            @foreach (var c in cats)
                            { 
                                <option value="@c.Id">@c.Name</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nombre</label>
                        <input type="text" name="name" class="form-control" id="editTagName" required />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-modal-cancel" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-modal-save">
                        <i class="fas fa-save me-2"></i>Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const editCatModal = document.getElementById('editCategoryModal');
            if (editCatModal) {
                editCatModal.addEventListener('show.bs.modal', function(event) {
                    const button = event.relatedTarget;
                    document.getElementById('editCatId').value = button.getAttribute('data-cat-id');
                    document.getElementById('editCatName').value = button.getAttribute('data-cat-name');
                    document.getElementById('editCatDescription').value = button.getAttribute('data-cat-description') || '';
                });
            }

            const editTagModal = document.getElementById('editTagModal');
            if (editTagModal) {
                editTagModal.addEventListener('show.bs.modal', function(event) {
                    const button = event.relatedTarget;
                    document.getElementById('editTagId').value = button.getAttribute('data-tag-id');
                    document.getElementById('editTagName').value = button.getAttribute('data-tag-name');
                    document.getElementById('editCategoryId').value = button.getAttribute('data-category-id');
                });
            }

            document.querySelectorAll('.table-premium tbody tr').forEach((row, index) => {
                row.style.opacity = '0';
                row.style.transform = 'translateX(-20px)';
                setTimeout(() => {
                    row.style.transition = 'all 0.5s ease';
                    row.style.opacity = '1';
                    row.style.transform = 'translateX(0)';
                }, index * 50);
            });

            const successMessage = '@Html.Raw(TempData["Success"] ?? "")';
            const errorMessage = '@Html.Raw(TempData["Error"] ?? "")';

            if (successMessage) showToast('Éxito', successMessage, 'success');
            if (errorMessage) showToast('Error', errorMessage, 'error');

            document.querySelectorAll('form').forEach(form => {
                form.addEventListener('submit', function(e) {
                    const submitBtn = this.querySelector('button[type="submit"]');
                    if (submitBtn && !submitBtn.classList.contains('btn-action')) {
                        const nameInput = this.querySelector('input[name="name"]');
                        if (nameInput && nameInput.value.trim().length < 2) {
                            e.preventDefault();
                            showToast('Error', 'El nombre debe tener al menos 2 caracteres.', 'error');
                            nameInput.focus();
                            return;
                        }
                        const originalHTML = submitBtn.innerHTML;
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Procesando...';
                        submitBtn.disabled = true;
                    }
                });
            });
        });

        function showToast(title, message, type) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast-premium ${type}`;
            const icon = type === 'success' ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-exclamation-circle"></i>';
            toast.innerHTML = `
                <div class="toast-icon">${icon}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.5s ease reverse';
                setTimeout(() => toast.remove(), 500);
            }, 5000);
        }
    </script>
}