<!DOCTYPE html>
<html lang="en">
<head>
<title>Kairassa - Mi Cuenta</title>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="telephone=no" name="format-detection"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="TemplatesJungle" name="author"/>
<meta content="ecommerce,fashion,store" name="keywords"/>
<meta content="Bootstrap 5 Fashion Store HTML CSS Template" name="description"/>
<link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" rel="stylesheet"/>
<link href="css/kaira/vendor.css" rel="stylesheet" type="text/css"/>
<link href="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.css" rel="stylesheet">
<link href="style.css" rel="stylesheet" type="text/css"/>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Jost:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&amp;family=Marcellus&amp;display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="~/css/kaira/enhanced.css">

<style>
    .account-container {
      min-height: 70vh;
      display: flex;
      align-items: center;
    }
    
    .account-card {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      max-width: 900px;
      margin: 0 auto;
    }
    
    .account-tabs {
      background: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
    }
    
    .account-tabs .nav-link {
      border: none;
      background: transparent;
      color: #6c757d;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 1.5rem 2rem;
      transition: all 0.3s ease;
    }
    
    .account-tabs .nav-link.active {
      background: #fff;
      color: #111;
      border-bottom: 3px solid #111;
    }
    
    .account-tabs .nav-link:hover {
      color: #111;
    }
    
    .form-container {
      padding: 3rem 2rem;
    }
    
    .form-title {
      font-family: 'Marcellus', serif;
      font-size: 2rem;
      color: #111;
      margin-bottom: 1.5rem;
      text-align: center;
    }
    
    .form-subtitle {
      color: #6c757d;
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-label {
      font-weight: 500;
      color: #111;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      font-size: 0.875rem;
      letter-spacing: 0.5px;
    }
    
    .form-control {
      border: 2px solid #e9ecef;
      border-radius: 0;
      padding: 1rem;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: #fff;
    }
    
    .form-control:focus {
      border-color: #111;
      box-shadow: none;
      background: #fff;
    }
    
    .btn-account {
      background: #111;
      border: 2px solid #111;
      color: #fff;
      padding: 1rem 2rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.3s ease;
      width: 100%;
      border-radius: 0;
    }
    
    .btn-account:hover {
      background: #fff;
      color: #111;
      border-color: #111;
    }
    
    .btn-secondary-account {
      background: transparent;
      border: 2px solid #6c757d;
      color: #6c757d;
      padding: 1rem 2rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.3s ease;
      width: 100%;
      border-radius: 0;
    }
    
    .btn-secondary-account:hover {
      background: #6c757d;
      color: #fff;
      border-color: #6c757d;
    }
    
    .divider {
      text-align: center;
      margin: 2rem 0;
      position: relative;
    }
    
    .divider::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 1px;
      background: #dee2e6;
    }
    
    .divider span {
      background: #fff;
      padding: 0 1rem;
      color: #6c757d;
      text-transform: uppercase;
      font-size: 0.875rem;
      letter-spacing: 0.5px;
    }
    
    .social-login {
      margin-top: 2rem;
    }
    
    .btn-social {
      border: 2px solid #dee2e6;
      background: #fff;
      color: #6c757d;
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
      transition: all 0.3s ease;
      width: 100%;
      border-radius: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .btn-social:hover {
      border-color: #111;
      color: #111;
    }
    
    .forgot-password {
      text-align: center;
      margin-top: 1rem;
    }
    
    .forgot-password a {
      color: #6c757d;
      text-decoration: none;
      font-size: 0.875rem;
      transition: color 0.3s ease;
    }
    
    .forgot-password a:hover {
      color: #111;
    }
    
    .form-check-input:checked {
      background-color: #111;
      border-color: #111;
    }
    
    .form-check-input:focus {
      border-color: #111;
      outline: 0;
      box-shadow: 0 0 0 0.25rem rgba(17, 17, 17, 0.25);
    }
    
    
    
    /* Estilos para las alertas */
    .alert-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1055;
      max-width: 400px;
    }
    
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1055;
    }
  </style>
</head>
<body>
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<defs>
<symbol id="user" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M15.71 12.71a6 6 0 1 0-7.42 0a10 10 0 0 0-6.22 8.18a1 1 0 0 0 2 .22a8 8 0 0 1 15.9 0a1 1 0 0 0 1 .89h.11a1 1 0 0 0 .88-1.1a10 10 0 0 0-6.25-8.19ZM12 12a4 4 0 1 1 4-4a4 4 0 0 1-4 4Z" fill="currentColor"></path>
</symbol>
<symbol id="search" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M21.71 20.29L18 16.61A9 9 0 1 0 16.61 18l3.68 3.68a1 1 0 0 0 1.42 0a1 1 0 0 0 0-1.39ZM11 18a7 7 0 1 1 7-7a7 7 0 0 1-7 7Z" fill="currentColor"></path>
</symbol>
<symbol id="cart" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M8.5 19a1.5 1.5 0 1 0 1.5 1.5A1.5 1.5 0 0 0 8.5 19ZM19 16H7a1 1 0 0 1 0-2h8.491a3.013 3.013 0 0 0 2.885-2.176l1.585-5.55A1 1 0 0 0 19 5H6.74a3.007 3.007 0 0 0-2.82-2H3a1 1 0 0 0 0 2h.921a1.005 1.005 0 0 1 .962.725l.155.545v.005l1.641 5.742A3 3 0 0 0 7 18h12a1 1 0 0 0 0-2Zm-1.326-9l-1.22 4.274a1.005 1.005 0 0 1-.963.726H8.754l-.255-.892L7.326 7ZM16.5 19a1.5 1.5 0 1 0 1.5 1.5a1.5 1.5 0 0 0-1.5-1.5Z" fill="currentColor"></path>
</symbol>
<symbol id="heart" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M20.16 4.61A6.27 6.27 0 0 0 12 4a6.27 6.27 0 0 0-8.16 9.48l7.45 7.45a1 1 0 0 0 1.42 0l7.45-7.45a6.27 6.27 0 0 0 0-8.87Zm-1.41 7.46L12 18.81l-6.75-6.74a4.28 4.28 0 0 1 3-7.3a4.25 4.25 0 0 1 3 1.25a1 1 0 0 0 1.42 0a4.27 4.27 0 0 1 6 6.05Z" fill="currentColor"></path>
</symbol>
</defs>
</svg>

<!-- Alertas y Toasts -->
<div class="alert-container">
    <div id="loginAlert" class="alert alert-danger d-none alert-dismissible fade show" role="alert">
        <span id="loginAlertMessage"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
    </div>
    <div id="registerAlert" class="alert alert-danger d-none alert-dismissible fade show" role="alert">
        <span id="registerAlertMessage"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
    </div>
    <div id="forgotAlert" class="alert alert-danger d-none alert-dismissible fade show" role="alert">
        <span id="forgotAlertMessage"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
    </div>
</div>

<div class="toast-container">
    <div id="loginToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                Inicio de Sesión Correcto
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
        </div>
    </div>
    <div id="registerToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                Registro Completado Correctamente
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
        </div>
    </div>
    <div id="forgotToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                Enlace de recuperación enviado
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
        </div>
    </div>
</div>

<!-- Account Section -->
<section class="account-container py-5">
<div class="container">
<div class="row justify-content-center">
<div class="col-lg-10">
<div class="account-card">
<!-- Tabs Navigation -->
<ul class="nav nav-tabs account-tabs justify-content-center" id="accountTabs" role="tablist">
<li class="nav-item" role="presentation">
<button aria-controls="login" aria-selected="true" class="nav-link active" data-bs-target="#login" data-bs-toggle="tab" id="login-tab" role="tab" type="button">
                  Iniciar Sesión
                </button>
</li>
<li class="nav-item" role="presentation">
<button aria-controls="register" aria-selected="false" class="nav-link" data-bs-target="#register" data-bs-toggle="tab" id="register-tab" role="tab" type="button">
                  Registrarse
                </button>
</li>
</ul>
<!-- Tabs Content -->
<div class="tab-content" id="accountTabContent">

<!-- Login Tab -->
<div aria-labelledby="login-tab" class="tab-pane fade show active" id="login" role="tabpanel">
<div class="form-container">
<h2 class="form-title">Bienvenido de vuelta</h2>
<p class="form-subtitle">Inicia sesión en tu cuenta para continuar</p>
<form action="/Account/Login" id="loginForm" method="post" autocomplete="off">@Html.AntiForgeryToken()
<div class="row">
<div class="col-12">
<div class="form-group">
<label class="form-label" for="loginEmail">Email</label>
<input class="form-control" id="loginEmail" name="email" placeholder="tu@email.com" required="" type="email" autocomplete="off" autocapitalize="none" spellcheck="false" inputmode="email"/>
<div id="loginAlert" class="alert alert-danger d-none mt-3" role="alert"></div>
</div>
</div>
<div class="col-12">
<div class="form-group">
<label class="form-label" for="loginPassword">Contraseña</label>
<input class="form-control" id="loginPassword" name="password" placeholder="Tu contraseña" required="" type="password"  autocomplete="new-password" autocapitalize="none" spellcheck="false" />
</div>
</div>
<div class="col-12">
<div class="form-check mb-3">
<input class="form-check-input" id="rememberMe" name="rememberMe" type="checkbox" value=""/>
<label class="form-check-label" for="rememberMe">
                            Recordarme
                          </label>
</div>
</div>
<div class="col-12">
<button class="btn btn-account" type="submit">Iniciar Sesión</button>
</div>
</div>
</form>
<div class="forgot-password">
<a href="#" id="goToForgot">¿Olvidaste tu contraseña?</a>
</div>
</div>
</div>

<!-- Register Tab -->
<div aria-labelledby="register-tab" class="tab-pane fade" id="register" role="tabpanel">
<div class="form-container">
<h2 class="form-title">Crear cuenta</h2>
<p class="form-subtitle">Únete a nuestra comunidad de fashion lovers</p>
<form action="/Account/Register" id="registerForm" method="post" autocomplete="off">@Html.AntiForgeryToken()
<div class="row">
<div class="col-md-6">
<div class="form-group">
<label class="form-label" for="firstName">Nombre</label>
<input class="form-control" id="firstName" name="firstName" placeholder="Tu nombre" required="" type="text"/>
</div>
</div>
<div class="col-md-6">
<div class="form-group">
<label class="form-label" for="lastName">Apellido</label>
<input class="form-control" id="lastName" name="lastName" placeholder="Tu apellido" required="" type="text"/>
</div>
</div>
<div class="col-12">
<div class="form-group">
<label class="form-label" for="registerEmail">Email</label>
<input class="form-control" id="registerEmail" name="email" placeholder="tu@email.com" required="" type="email" autocomplete="off" autocapitalize="none" spellcheck="false" inputmode="email"/>
</div>
</div>
<div class="col-md-6">
<div class="form-group">
<label class="form-label" for="registerPassword">Contraseña</label>
<input class="form-control" id="registerPassword" minlength="6" name="password" placeholder="Tu contraseña" required="" type="password" autocomplete="new-password" autocapitalize="none" spellcheck="false"/>

<small id="passwordHelp" class="form-text text-muted d-block mt-1">
      La contraseña debe tener <strong>mínimo 8 caracteres</strong> e incluir
      <strong>mayúsculas</strong>, <strong>minúsculas</strong>, <strong>números</strong> y 
      <strong>símbolos</strong>.
    </small>

</div>
</div>

<!-- RPregunta de seguridad -->
<div class="col-md-6">
<div class="form-group">
<label class="form-label" for="confirmPassword">Confirmar contraseña</label>
<input class="form-control" id="confirmPassword" minlength="6" name="confirmPassword" placeholder="Confirma tu contraseña" required="" type="password"/>
</div>
</div>
<div class="row">
  <div class="col-md-6">
    <div class="form-group">
      <label class="form-label" for="SecurityQuestionKey">Pregunta de seguridad</label>
      <select class="form-control" id="SecurityQuestionKey" name="SecurityQuestionKey" required>
        <option value="">Selecciona una pregunta</option>
        <option value="pet">¿Cuál fue el nombre de tu primera mascota?</option>
        <option value="school">¿En qué primaria estudiaste?</option>
        <option value="city">¿En qué ciudad nació tu madre?</option>
        <option value="color">¿Cuál es tu color favorito?</option>
        <option value="nick">¿Cuál era tu apodo en la infancia?</option>
      </select>
      <small class="form-text text-muted">Guárdala bien. La usarás para recuperar tu cuenta.</small>
    </div>
  </div>

  <div class="col-md-6">
    <div class="form-group">
      <label class="form-label" for="SecurityAnswer">Respuesta</label>
      <input class="form-control" id="SecurityAnswer" name="SecurityAnswer" type="text" autocomplete="off" required />
      <small class="form-text text-muted">No uses datos obvios; evita tildes y mayúsculas innecesarias.</small>
    </div>
  </div>
</div>
<div class="col-12">
<div class="form-group">
<label class="form-label" for="phone">Teléfono (opcional)</label>
<input class="form-control" id="phone" name="phone" placeholder="+52 123 456 7890" type="tel"/>
</div>
</div>
<div class="col-12">
<div class="form-check mb-3">
<input class="form-check-input" id="agreeTerms" name="checkbox1" required="" type="checkbox" value=""/>
<label class="form-check-label" for="agreeTerms">
                            Acepto los <a class="text-decoration-none" href="#">términos y condiciones</a> y la 
                            <a class="text-decoration-none" href="#">política de privacidad</a>
</label>
</div>
</div>
<div class="col-12">
<button class="btn btn-account" type="submit">Crear Cuenta</button>
</div>
</div>
</form>
</div>
</div>

<!-- Forgot Password -->
<div class="tab-pane fade" id="forgot-password" role="tabpanel">
  <div class="form-container">

    <h2 class="form-title">Recuperar contraseña</h2>
    <p class="form-subtitle">Ingresa tu correo y responde tu pregunta de seguridad.</p>

    <!-- ÚNICO FORMULARIO: incluye todo el flujo -->
    <form id="resetDirectForm" method="post" action="/account/reset-direct" autocomplete="off">
      @Html.AntiForgeryToken()

      <!-- Paso 1: Email -->
      <div id="fpStep1" class="row">
        <div class="col-12">
          <div class="form-group">
            <label class="form-label" for="Email">Email</label>
            <input class="form-control" id="Email" name="Email" type="email" required autocomplete="off" autocapitalize="none" spellcheck="false" inputmode="email"/>
          </div>
        </div>
        <div class="col-12 mt-3">
          <button id="btnForgotContinue" type="button" class="btn btn-account w-100">Continuar</button>
        </div>
      </div>

      <!-- Alertas -->
      <div class="row mt-3">
        <div class="col-12">
          <div id="fpAlert" class="alert alert-danger d-none" role="alert"></div>
        </div>
      </div>

      <!-- Paso 2: Pregunta + respuesta -->
      <div id="secQBlock" class="row mt-3 d-none">
        <div class="col-12">
          <div class="form-group">
            <label class="form-label">Pregunta de seguridad</label>
            <input class="form-control" id="fpQuestion" type="text" readonly />
          </div>
        </div>
        <div class="col-12">
          <div class="form-group">
            <label class="form-label" for="fpAnswer">Tu respuesta</label>
            <input class="form-control" id="fpAnswer" type="text" autocomplete="off" />
          </div>
        </div>
        <div class="col-12">
          <button class="btn btn-account" type="button" id="btnVerifyAnswer">Verificar</button>
        </div>
      </div>

      <!-- Paso 3: Nuevas contraseñas (visible sólo si la respuesta es correcta) -->
      <div id="pwdSection" class="row d-none">
        <div class="col-12">
          <div class="form-group">
            <label class="form-label" for="Password">Nueva contraseña</label>
            <input
              class="form-control"
              id="Password"
              name="Password"
              type="password"
              minlength="8"
              autocomplete="new-password"
              pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z0-9]).{8,}$"
              required
              aria-describedby="pwdPolicyHelp invalidPwdFeedback" />
            <div id="pwdPolicyHelp" class="form-text">
              La contraseña debe tener <strong>mínimo 8 caracteres</strong> e incluir
              <strong>mayúsculas</strong>, <strong>minúsculas</strong>,
              <strong>números</strong> y <strong>símbolos</strong>.
            </div>
            <div id="invalidPwdFeedback" class="invalid-feedback">
              Tu contraseña no cumple la política (8+, mayúscula, minúscula, número y símbolo).
            </div>
          </div>
        </div>

        <div class="col-12">
          <div class="form-group">
            <label class="form-label" for="ConfirmPassword">Confirmar contraseña</label>
            <input
              class="form-control"
              id="ConfirmPassword"
              name="ConfirmPassword"
              type="password"
              autocomplete="new-password"
              required />
          </div>
        </div>

        <div class="col-12">
          <div id="pwdMismatch" class="alert alert-danger d-none">Las contraseñas no coinciden.</div>
          <button id="btnSavePwd" type="submit" class="btn btn-account w-100" disabled>
            Guardar nueva contraseña
          </button>
        </div>
      </div>
    </form>

  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
        crossorigin="anonymous"></script>

<script>
  // Validación de confirmación de contraseña (registro)
  document.addEventListener('DOMContentLoaded', function () {
    const password = document.getElementById('registerPassword');
    const confirmPassword = document.getElementById('confirmPassword');

    function validatePasswords() {
      if (password && confirmPassword) {
        if (password.value !== confirmPassword.value) {
          confirmPassword.setCustomValidity('Las contraseñas no coinciden');
          confirmPassword.classList.add('is-invalid');
        } else {
          confirmPassword.setCustomValidity('');
          confirmPassword.classList.remove('is-invalid');
        }
      }
    }

    if (password && confirmPassword) {
      password.addEventListener('input', validatePasswords);
      confirmPassword.addEventListener('input', validatePasswords);
    }

    // Micro-interacciones de inputs
    document.querySelectorAll('.form-control').forEach(function (input) {
      input.addEventListener('focus', function () {
        this.parentElement.classList.add('focused');
      });
      input.addEventListener('blur', function () {
        if (!this.value) this.parentElement.classList.remove('focused');
      });
    });
  });

  // Mostrar formulario "Olvidé mi contraseña"
  function showForgotPassword() {
    document.getElementById('login')?.classList.remove('show', 'active');
    document.getElementById('register')?.classList.remove('show', 'active');
    document.getElementById('login-tab')?.classList.remove('active');
    document.getElementById('register-tab')?.classList.remove('active');

    document.getElementById('forgot-password')?.classList.add('show', 'active');
    document.getElementById('accountTabs')?.style && (document.getElementById('accountTabs').style.display = 'none');
  }

  // Volver a login
  function showLogin() {
    document.getElementById('forgot-password')?.classList.remove('show', 'active');
    document.getElementById('login')?.classList.add('show', 'active');
    document.getElementById('login-tab')?.classList.add('active');
    document.getElementById('accountTabs')?.style && (document.getElementById('accountTabs').style.display = 'flex');
  }

  // Helpers UI (alertas / toasts)
  function showAlert(alertId, message, type = 'danger') {
    const alertBox = document.getElementById(alertId);
    const alertMessage = document.getElementById(alertId + 'Message') || alertBox;
    if (!alertBox) return;

    alertBox.className = `alert alert-${type} d-none alert-dismissible fade show`;
    alertMessage.textContent = message;
    alertBox.classList.remove('d-none');

    setTimeout(() => alertBox.classList.add('d-none'), 5000);
  }

  function showToast(toastId) {
    const el = document.getElementById(toastId);
    if (el && window.bootstrap) {
      new bootstrap.Toast(el).show();
    }
  }
</script>

<script>
  // Hook Ajax común (login/registro/forgot)
  (async function () {
    // Si ya está autenticado, redirige
    try {
      const st = await fetch('/Account/Status', { credentials: 'same-origin' });
      const s = await st.json();
      if (s.authenticated && s.redirect) {
        localStorage.setItem('tp_auth', JSON.stringify({ authenticated: true, roles: s.roles || [] }));
        window.location.href = s.redirect;
        return;
      } else {
        localStorage.removeItem('tp_auth');
      }
    } catch { /* silencioso */ }

    function hook(formId, endpoint) {
      const f = document.getElementById(formId);
      if (!f || f.dataset.bound) return;
      f.dataset.bound = "1";

      f.addEventListener('submit', async (e) => {
        e.preventDefault();

        const tokenEl = f.querySelector('input[name="__RequestVerificationToken"]');
        const token = tokenEl ? tokenEl.value : null;
        const fd = new FormData(f);

        try {
          const res = await fetch(endpoint, {
            method: 'POST',
            body: fd,
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              ...(token ? { 'RequestVerificationToken': token } : {})
            },
            credentials: 'same-origin'
          });

          const ct = (res.headers.get('content-type') || '').toLowerCase();
          const text = await res.text();
          if (!ct.includes('application/json')) return;

          let data; try { data = JSON.parse(text); } catch { return; }

          if (data.ok) {
            try {
              const st = await fetch('/Account/Status', { credentials: 'same-origin' });
              const s = await st.json();
              if (s.authenticated) {
                localStorage.setItem('tp_auth', JSON.stringify({ authenticated: true, roles: s.roles || [] }));
              } else {
                localStorage.removeItem('tp_auth');
              }
            } catch { }

            if (formId === 'loginForm')      showToast('loginToast');
            else if (formId === 'registerForm') showToast('registerToast');
            else if (formId === 'forgotForm')   showToast('forgotToast');

            if (data.redirectUrl) setTimeout(() => window.location.href = data.redirectUrl, 2000);
          } else {
            if (formId === 'loginForm')        showAlert('loginAlert',    data.error || 'Error en la operación.');
            else if (formId === 'registerForm') showAlert('registerAlert', data.error || 'Error en la operación.');
            else if (formId === 'forgotForm')   showAlert('forgotAlert',   data.error || 'Error en la operación.');
          }
        } catch { /* red silenciosa */ }
      });
    }

    hook('loginForm', '/Account/Login');
    hook('registerForm', '/Account/Register');
  })();
</script>

<script>
  // Ir a "Recuperar contraseña" sin exigir email en el login
  document.getElementById('goToForgot')?.addEventListener('click', async function (e) {
    e.preventDefault();

    const emailLogin  = document.getElementById('loginEmail');
    const email       = (emailLogin?.value || '').trim();

    // 1) Abrir SIEMPRE el panel de recuperar
    showForgotPassword();

    // 2) Si hay un input email en el panel de recuperar, pre-llenar
    const forgotEmail = document.getElementById('Email');
    if (forgotEmail && email) forgotEmail.value = email;

    // 3) Si hay email, intentamos cargar la pregunta. Si no, solo dejamos el panel abierto.
    if (email) {
      try {
        const data = await apiEmailExists(email);
        if (data?.exists) {
          // dispara la carga de la pregunta (si definiste __secqFetchQuestion)
          setTimeout(() => { window.__secqFetchQuestion && window.__secqFetchQuestion(); }, 50);
        } else {
          // mostramos el aviso en el panel de recuperar (no en login)
          showAlert('forgotAlert', 'No existe una cuenta con ese correo.');
        }
      } catch { /* silencioso */ }
    } else {
      // si entraste sin email, ocultamos pregunta/contraseñas por si estuvieran visibles
      document.getElementById('secQBlock')?.classList.add('d-none');
      document.getElementById('pwdSection')?.classList.add('d-none');
      // limpia cualquier alerta en el login
      document.getElementById('loginAlert')?.classList.add('d-none');
    }
  });
</script>


<script>
(function(){
  const emailInput  = document.getElementById('Email');
  const btnContinue = document.getElementById('btnForgotContinue');

  const secQBlock   = document.getElementById('secQBlock');
  const fpQuestion  = document.getElementById('fpQuestion');
  const fpAnswer    = document.getElementById('fpAnswer');
  const btnVerify   = document.getElementById('btnVerifyAnswer');

  const formReset   = document.getElementById('resetDirectForm');
  const hiddenEmail = document.getElementById('hiddenEmail');
  const pwdSection  = document.getElementById('pwdSection');
  const btnSavePwd  = document.getElementById('btnSavePwd');

  const fpAlert     = document.getElementById('fpAlert');
  function hideFpAlert(){ fpAlert?.classList.add('d-none'); }

  function setPwdUI(enabled) {
    if (pwdSection) pwdSection.classList.toggle('d-none', !enabled);
    if (btnSavePwd) btnSavePwd.disabled = !enabled;
  }
  setPwdUI(false);

  // Paso 1: validar correo y cargar pregunta
  async function onContinue(){
    hideFpAlert();

    const email = (emailInput?.value || '').trim();
    if (!email) { showAlert('fpAlert','Ingresa tu correo.'); return; }

    try{
      const res = await fetch('/account/forgot-check-email?email='+encodeURIComponent(email), { credentials:'same-origin' });
      const data = await res.json();

      if (!data.ok){
        if (data.needsSetup) {
          showAlert('fpAlert', data.error || 'Configura tu pregunta de seguridad desde tu perfil.', 'warning');
        } else {
          showAlert('fpAlert', data.error || 'No pudimos validar el correo.');
        }
        return;
      }

      if (fpQuestion) fpQuestion.value = data.questionText || 'Pregunta de seguridad';
      if (hiddenEmail) hiddenEmail.value = email;
      if (secQBlock) secQBlock.classList.remove('d-none');
      fpAnswer?.focus();
    } catch {
      showAlert('fpAlert','No se pudo consultar la pregunta.');
    }
  }

  // Paso 2: verificar respuesta
  async function onVerify(){
    hideFpAlert();

    const email  = (hiddenEmail?.value || emailInput?.value || '').trim();
    const answer = (fpAnswer?.value || '').trim();
    if (!email)  { showAlert('fpAlert','Ingresa tu correo.'); return; }
    if (!answer) { showAlert('fpAlert','Escribe tu respuesta.'); return; }

    const tokenEl = formReset?.querySelector('input[name="__RequestVerificationToken"]');
    const token = tokenEl ? tokenEl.value : null;

    try{
      const res = await fetch('/account/verify-security-answer', {
        method:'POST',
        credentials:'same-origin',
        headers:{
          'Content-Type':'application/json',
          'X-Requested-With':'XMLHttpRequest',
          ...(token ? { 'RequestVerificationToken': token } : {})
        },
        body: JSON.stringify({ email, answer })
      });
      const data = await res.json();
      if (!data.ok){
        setPwdUI(false);
        showAlert('fpAlert', data.error || 'Respuesta incorrecta.');
        return;
      }
      setPwdUI(true);
      showAlert('fpAlert', 'Pregunta verificada. Ahora define tu nueva contraseña.', 'success');
      document.getElementById('Password')?.focus();
    } catch {
      showAlert('fpAlert','No se pudo verificar. Intenta de nuevo.');
    }
  }

  // Validación de coincidencia antes de enviar
  formReset?.addEventListener('submit', function(e){
    hideFpAlert();
    const p = document.getElementById('Password')?.value || '';
    const c = document.getElementById('ConfirmPassword')?.value || '';
    const box = document.getElementById('pwdMismatch');
    box?.classList.add('d-none');
    if (p !== c) {
      e.preventDefault();
      box?.classList.remove('d-none');
      document.getElementById('ConfirmPassword')?.focus();
    }
  });

  btnContinue?.addEventListener('click', onContinue);
  btnVerify?.addEventListener('click', onVerify);
})();
</script>

<script>
(function(){
  function clearIds(ids){
    ids.forEach(id => { const el = document.getElementById(id); if (el) { el.value = ''; el.blur(); } });
  }

  // Limpiar al cargar (incluye navegación con bfcache)
  window.addEventListener('pageshow', () => {
    clearIds(['loginEmail','loginPassword','regEmail','registerPassword','confirmPassword',
              'Email','Password','ConfirmPassword','fpAnswer']);
  });

  // Integrarlo con tus helpers
  const _showForgotPassword = window.showForgotPassword;
  window.showForgotPassword = function(){
    clearIds(['Email','Password','ConfirmPassword','fpAnswer']);
    if (_showForgotPassword) _showForgotPassword();
  };

  const _showLogin = window.showLogin;
  window.showLogin = function(){
    clearIds(['loginEmail','loginPassword']);
    if (_showLogin) _showLogin();
  };

  // Si tienes tab de registro:
  const regTab = document.getElementById('register-tab');
  regTab?.addEventListener('click', () => clearIds(['regEmail','registerPassword','confirmPassword']));
})();
</script>

<script>
(function () {
  const form = document.getElementById('resetDirectForm');
  const p1   = document.getElementById('Password');
  const p2   = document.getElementById('ConfirmPassword');
  const mismatch = document.getElementById('pwdMismatch');
  const btnSave  = document.getElementById('btnSavePwd');

  function meetsPolicy(s) {
    return s.length >= 8 &&
           /[A-Z]/.test(s) &&
           /[a-z]/.test(s) &&
           /\d/.test(s) &&
           /[^A-Za-z0-9]/.test(s);
  }

  function validatePolicy() {
    if (!p1) return true;
    const ok = meetsPolicy(p1.value);
    // Marca visual si el usuario ya empezó a tipear
    p1.classList.toggle('is-invalid', p1.value.length > 0 && !ok);
    return ok;
  }

  function validateMatch() {
    if (!p1 || !p2) return true;
    const ok = p1.value === p2.value && p2.value.length > 0;
    mismatch?.classList.toggle('d-none', ok);
    return ok;
  }

  function updateButton() {
    const ok = validatePolicy() && validateMatch();
    if (btnSave) btnSave.disabled = !ok;
  }

  p1?.addEventListener('input', () => { validatePolicy(); updateButton(); });
  p2?.addEventListener('input', () => { validateMatch();  updateButton(); });

  form?.addEventListener('submit', (e) => {
    const okPolicy = validatePolicy();
    const okMatch  = validateMatch();
    if (!(okPolicy && okMatch)) {
      e.preventDefault();
      (!okPolicy ? p1 : p2)?.focus();
    }
  });
})();
</script>

</body>
</html>